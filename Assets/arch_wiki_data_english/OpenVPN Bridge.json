{
  "title": "OpenVPN Bridge",
  "url": "https://wiki.archlinux.org/title/OpenVPN_Bridge",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "This page describes how to create a network bridge on Arch Linux and host an OpenVPN server using a IP layer-2 based Ethernet bridge (TAP) rather than a IP layer-3 based IP tunnel (TUN). The general OpenVPN page describes setting up PAM authentication or OpenSSL security certificates in more detail.\n\n"
    },
    {
      "title": "Introduction",
      "level": 2,
      "content": "The OpenVPN documentation page gives a full overview of server-side and client-side options that OpenVPN supports. It is easier to set up OpenVPN in tunneling mode and control routing the traffic and it is generally advised to do so if it serves your purpose. However, some network applications, such as Windows file sharing, rely on network broadcasts at the Ethernet level and benefit from believing they are physically located on the same subnet, and software bridging serves this purpose.\n\nThere are multiple ways to set bridging up. The dynamic method is where OpenVPN will be managing its own bridge on the system and will start, stop and configure it itself. This is the quickest way to set bridging up, although it interrupts other network services when OpenVPN starts and stops. If the system is going to manage its own bridge, maybe because other virtual network adapters connect to the bridge besides just that of OpenVPN, then it is preferable to use the static method.\n\n"
    },
    {
      "title": "Dynamic Bridge Installation",
      "level": 2,
      "content": "You will need to install OpenVPN and Linux bridging utilities which are available in the openvpn and bridge-utils packages. To use the example script below you will also need to install the dhcpcd package.\n\n"
    },
    {
      "title": "Dynamic Bridge Configuration",
      "level": 2,
      "content": "OpenVPN will create/destroy the TAP device automatically for the name specified in the configuration file. OpenVPN settings common to TUN or TAP are not shown in the example configuration file below, only settings that affect TAP mode. Make sure the up and down scripts are executable after you write them.\n\n(sections common to TUN and TAP omitted)\n\n```\n/etc/openvpn/server.conf\n```\n\n```\n# this uses a dhcp server, server-side\n#  clients must support binding their dhcp client to their tap adapter\n# do not append 'nogw' if using dhcp\nserver-bridge\n# can specify interface, like tap0 or tap1\n#  or use up/down routing scripts to handle\n#  more than one, if needed\ndev tap0\n# needed to call scripts like up/down\n#  which call external programs within the scripts\nscript-security 2\n# user defined scripts for adding/removing tap to bridge\n#  'dev mtu link_mtu ifconfig_local_ip ifconfig_remote_ip' are appended if set\n# make sure 'user' has permission to run 'down' ('up' will be root)\nup \"up br0 eth0\"\ndown \"down br0 eth0\"\n# call 'down' before TUN/TAP close\ndown-pre\n# drop root priveledges once connected\n#  good idea, for servers running on linux\n# 'up' script not affected, 'down' script is\n;user nobody\n;group nobody\n```\n\n```\n/etc/openvpn/up\n```\n\n```\n#!/bin/bash\nbr=$1\neth=$2\ndev=$3\nmtu=$4\ncd /usr/bin/\n\n# only if you start dhcpcd and leave it\n#  running for eth\n#dhcpcd -k $eth\n\n# needed if script is run independently\n# but when run through openvpn\n# openvpn will do this automatically\n#  could also use 'ip tuntap ..'\n#openvpn --mktun --dev $dev\n\nbrctl addbr $br\n# set forwarding delay to 0\n#  otherwise dhcp called below would timeout\nbrctl setfd $br 0\nbrctl addif $br $eth\n# order matters here.. right now there is only\n#  one mac in the bridge's table\n# if there were two.. there is no guarantee\n#  which would be passed to the dhcp server\ndhcpcd $br\nbrctl addif $br $dev\n\nip link set $eth up promisc on mtu $mtu\nip link set $dev up promisc on mtu $mtu\n```\n\n```\n/etc/openvpn/down\n```\n\n```\n#!/bin/bash\nbr=$1\neth=$2\ncd /usr/bin/\n\ndhcpcd -k $br\n\nip link set $br down\nbrctl delbr $br\n\n# needed if script is run independently\n# but when run through openvpn\n# openvpn will do this automatically\n#  could also use 'ip tuntap ..'\n#openvpn --rmtun --dev $dev\n\n# only if you start dhcpcd and leave it\n#  running for eth\n#dhcpcd $eth\n```\n\nThese examples are for using dhcp. If you are going to use static IP addresses, you will need to adjust accordingly.\n\n"
    },
    {
      "title": "Using Systemd",
      "level": 2,
      "content": "The OpenVPN systemd script looks for <name>.conf files in the /etc/openvpn folder by default. So assuming you have a file named server.conf, you can enable and start openvpn@server.\n\nBe careful about having dhcpcd enabled separately (ie. dhcpcd@eth0.service) at the same time. It is possible, though unlikely, for it to complete after OpenVPN and ruin your dhcp setup for OpenVPN. You could probably disable dhcpcd@eth0.service since you know openvpn@server.service will be resetting dhcp anyway.\n\n"
    },
    {
      "title": "Static Bridge Installation",
      "level": 2,
      "content": "The first thing you want to do is install these packages: openvpn, bridge-utils, netctl.\n\n"
    },
    {
      "title": "Static Bridge Configuration",
      "level": 2,
      "content": "Earlier versions of guides for OpenVPN provided by the OpenVPN team or various Linux packagers give example scripts for constructing a bridge when starting OpenVPN and destroying it when shutting OpenVPN down.\n\nHowever, this is a somewhat deprecated approach, since OpenVPN as of 2.1.1 defaults to not allowing itself to call external scripts or programs unless explicitly enabled to, for security reasons.\n\nAlso, constructing the bridge is relatively slow compared to all other parts of the network initialization process. (In fact, so slow that dhcpcd will time out before the bridge is ready. See #Static Bridge Troubleshooting.) Also, when restarting OpenVPN after configuration changes, there is no reason to rebuild a working bridge, interrupting all your other network applications. So, setting up a static bridge configuration as follows is the recommended method.\n\nTo create an OpenVPN bridge for your server, you are going to have to use netctl and create two network profiles - one for the tap interface and one for the bridge.\n\nGo to /etc/netctl and copy the tuntap example file to the directory:\n\n```\n# cd /etc/netctl/\n# cp examples/tuntap openvpn_tap\n```\n\nNow edit openvpn_tap to create a tap interface. It may look like this:\n\n```\n/etc/netctl/openvpn_tap\n```\n\n```\nDescription='tuntap connection'\nInterface=tap0\nConnection=tuntap\nMode='tap'\nUser='nobody'\nGroup='nobody'\n```\n\nDo not configure the IP address here, this is going to be done for the bridge interface!\n\nTo create the bridge profile, copy the example file:\n\n```\n# cp examples/bridge openvpn_bridge\n```\n\nNow edit openvpn_bridge. It may look like this:\n\n```\n/etc/netctl/openvpn_bridge\n```\n\n```\nDescription=\"Bridge connection\"\nInterface=br0\nConnection=bridge\nBindsToInterfaces=(eth0 tap0)\nIP=static\nAddress=('192.168.11.1/24')\nGateway='192.168.11.254'\nDNS=('192.168.11.254')\n```\n\nFor more information, for example how to use DHCP instead, check the netctl article.\n\nNow enable and start both profiles with:\n\n```\n# netctl enable openvpn_tap\n# netctl enable openvpn_bridge\n# netctl start openvpn_tap\n# netctl start openvpn_bridge\n```\n\n"
    },
    {
      "title": "Failed to start the network",
      "level": 3,
      "content": "This is probably because you are using DHCP on the bridge and setting up the bridge takes longer than dhcpcd is willing to wait. You can fix this by setting the FWD_DELAY parameter in your bridge network profile (openvpn_bridge). Start with a value of 5 and decrease it until it works.\n\n"
    },
    {
      "title": "No IP Address on bridge when using DHCP",
      "level": 3,
      "content": "You may need to release the IP address that is assigned to your ethernet interface before requesting an IP through via DHCP. To do this:\n\n```\ndhcpcd -k\n```\n\nThen, modify the dhcpcd conf file to ensure that an ip address is not assigned to the ethernet interface (in this case, enp3s0):\n\n```\n/etc/dhcpcd.conf\n```\n\n```\ndenyinterfaces enp3s0\n```\n\nTowards the end of the file (assuming your bridge is named br0):\n\n```\n/etc/dhcpcd.conf\n```\n\n```\ninterface br0\n```\n\nNow create the network bridge as described above, then run dhcpcd to assign the ip address to your interface. Check to see that ip addr shows a valid ip address assigned to the bridge (i.e. br0).\n\n"
    },
    {
      "title": "More Resources",
      "level": 2,
      "content": "- OpenVPN - General page on configuring OpenVPN, including setting up authentication methods.\n\n"
    }
  ]
}