{
  "title": "VPN over SSH",
  "url": "https://wiki.archlinux.org/title/VPN_over_SSH",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "There are several ways to set up a Virtual Private Network through SSH. Note that, while this may be useful from time to time, it may not be a full replacement for a regular VPN. See for example [1].\n\n"
    },
    {
      "title": "Using badvpn's tun2socks",
      "level": 2,
      "content": "badvpn is a collection of utilities for various VPN-related use cases.\n\n"
    },
    {
      "title": "Start SSH dynamic SOCKS proxy",
      "level": 3,
      "content": "First, we will set up a normal SSH dynamic socks proxy like usual:\n\n```\n$ ssh -TND 4711 <your_user>@<SSH_server>\n```\n\n"
    },
    {
      "title": "Set up badvpn and tunnel interface",
      "level": 3,
      "content": "Afterwards, we can go ahead with setting up the TUN.\n\n```\n# ip tuntap add dev tun0 mode tun user <your_local_user>\n# ip addr replace 10.0.0.1/24 dev tun0\n# badvpn-tun2socks --tundev tun0 --netif-ipaddr 10.0.0.2 --netif-netmask 255.255.255.0 --socks-server-addr localhost:4711\n```\n\nNow you have a working local tun0 interface which routes all traffic going into it through the SOCKS proxy you set up earlier.\n\n"
    },
    {
      "title": "Get traffic into the tunnel",
      "level": 3,
      "content": "All that's left to do now is to set up a local route to get some traffic into it. Let us set up a route that routes all traffic into it. We will need three routes:\n\n1. Route that goes to the SSH server that we use for the tunnel with a low metric.\n1. Route for DNS server (because tun2socks does not do UDP which is necessary for DNS) with a low metric.\n1. Default route for all other traffic with a higher metric than the other routes.\n\nThe idea behind setting the metrics specifically is because we need to ensure that the route picked to the SSH server is always direct because otherwise it would go back into the SSH tunnel which would cause a loop and we would lose the SSH connection as a result. Apart from that, we need to set an explicit DNS route because tun2socks does not tunnel UDP (required for DNS). We also need a new default route with a lower metric than your old default route so that traffic goes into the tunnel at all. With all of that said, let us get to work:\n\n```\n# ip route add <IP_of_SSH_server> via <IP_of_original_gateway> metric 5\n# ip route add <IP_of_DNS_server> via <IP_of_original_gateway> metric 5\n# ip route add default via 10.0.0.2 metric 6\n```\n\nNow all traffic (except for DNS and the SSH server itself) should go through tun0.\n\n"
    },
    {
      "title": "OpenSSH's built in tunneling",
      "level": 2,
      "content": "OpenSSH has built-in TUN/TAP support using -w<local-tun-number>:<remote-tun-number>. Here, a layer 3/point-to-point/ TUN tunnel is described. It is also possible to create a layer 2/ethernet/TAP tunnel.\n\n"
    },
    {
      "title": "Enable forwarding for the TUN device",
      "level": 3,
      "content": "To enable forwarding for the TUN device, edit /etc/ssh/sshd_config and set PermitTunnel to yes, point-to-point or ethernet. Setting yes enables forwarding for both point-to-point and ethernet tunnels. See sshd_config(5) for details.\n\n```\n/etc/ssh/sshd_config\n```\n\n```\n...\nPermitTunnel yes\n...\n```\n\nThen reload sshd.service.\n\n"
    },
    {
      "title": "Create tun interfaces using systemd-networkd",
      "level": 3,
      "content": "```\n/etc/systemd/network/vpn.netdev\n```\n\n```\n[NetDev]\nName=tun5\nKind=tun\n\n[Tun]\nUser=vpn\nGroup=network\n```\n\n```\n/etc/systemd/network/vpn.network\n```\n\n```\n[Match]\nName=tun5\n\n[Address]\nAddress=192.168.200.2/24\n```\n\nOnce these files are created, enable them by restarting systemd-networkd.service.\n\nAlso, you may manage tun interfaces with ip tunnel command.\n\n"
    },
    {
      "title": "Creating interfaces in SSH command",
      "level": 4,
      "content": "SSH creates both interfaces automatically, but IP and routing should be configured after the connection is established.\n\n```\nssh \\\n  -o PermitLocalCommand=yes \\\n  -o LocalCommand=\"sudo ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0\" \\\n  -o ServerAliveInterval=60 \\\n  -w 5:5 vpn@example.com \\\n  'sudo ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0; echo tun0 ready'\n```\n\n"
    },
    {
      "title": "Start SSH",
      "level": 3,
      "content": "```\nssh -f -w5:5 vpn@example.com -i ~/.ssh/key \"sleep 1000000000\"\n```\n\nor you may add keep-alive options if you are behind a NAT.\n\n```\nssh -f -w5:5 vpn@example.com \\\n        -o ServerAliveInterval=30 \\\n        -o ServerAliveCountMax=5 \\\n        -o TCPKeepAlive=yes \\\n        -i ~/.ssh/key \"sleep 1000000000\"\n```\n\n"
    },
    {
      "title": "Troubleshooting",
      "level": 3,
      "content": "- ssh should have access rights to tun interface or permissions to create it. Check owner of tun interface and/or /dev/net/tun.\n- Obviously if you want to access a network rather than a single machine you should properly set up IP packet forwarding, routing and maybe a netfilter on both sides.\n- If you do not enable tunneling, you may get the following error when you want to create an SSH tunnel using -w:\n\n```\nchannel 0: open failed: connect failed: open failed\nTunnel forwarding failed\n```\n\n"
    },
    {
      "title": "Using PPP over SSH",
      "level": 2,
      "content": "pppd can easily be used to create a tunnel through an SSH server:\n\n```\n# pppd updetach noauth silent nodeflate pty \"/usr/bin/ssh root@remote-gw /usr/sbin/pppd nodetach notty noauth\" ipparam vpn 10.0.8.1:10.0.8.2\n```\n\nWhen the VPN is established, you can route traffic through it. To get access to an internal network:\n\n```\n# ip route add 192.168.0.0/16 via 10.0.8.2\n```\n\nTo route all Internet traffic through the tunnel, for example, to protect your communication on an unencrypted network, first add a route to the SSH server through your regular gateway:\n\n```\n# ip route add <remote-gw> via <current default gateway>\n```\n\nNext, replace the default route with the tunnel\n\n```\n# ip route replace default via 10.0.8.2\n```\n\n"
    },
    {
      "title": "Helper script",
      "level": 3,
      "content": "pvpn (package pvpnAUR) is a wrapper script around pppd over SSH.\n\n"
    },
    {
      "title": "See also",
      "level": 2,
      "content": "- Network configuration\n- Router\n- OpenSSH\n- sshuttle, a tool written in Python which can create tunnels\n\n"
    }
  ]
}