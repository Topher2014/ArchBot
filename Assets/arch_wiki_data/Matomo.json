{
  "title": "Matomo",
  "url": "https://wiki.archlinux.org/title/Matomo",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Matomo, formerly Piwik, is an open source web analysis tool licensed under the GNU General Public License 3. The software is written in php and is accessed over the web browser. The core idea of the project is privacy as when using third party website analysis providers website owners are giving all of their users' data away for them to sell them to advertisers.\n\nWith one running instance multiple websites can be analysed by loading some JavaScript on the target websites.\n\n"
    },
    {
      "title": "Installation",
      "level": 2,
      "content": "Install the package matomoAUR or matomo-gitAUR. The git package already configures the php-fpm daemon for you. Additionally, it downloads and installs the most recent GeoIP database for you. By default, Matomo guesses the visitor's location by their set browser language which is not reliable information for geographical location.\n\n"
    },
    {
      "title": "php configuration",
      "level": 3,
      "content": "php needs to be configured properly for Matomo to work.\n\nFirst, enable MySQL support as described in PHP#MySQL/MariaDB. Do so by editing /etc/php/php.ini. Uncomment ;extension=pdo_mysql and ;extension=mysqli by removing the preceding semicolon.\n\nIn general, comments are indicated by preceding semicolons.\n\n;extension=iconv needs to be enabled and ;extension=gd is optional for Matomo. Uncomment at least iconv.\n\n"
    },
    {
      "title": "Allow Matomo access to needed files",
      "level": 4,
      "content": "Because of new restrictions on php-fpm.service since version 7.4, where ProtectSystem is set to prevent Matomo to function correctly (unable to installing plugins, changing configuration, etc), the ability to access certain files needs to be set manually.\n\nThe file /etc/systemd/system/php-fpm.service.d/override_matomo.conf below fixes the issue while not exposing more than necessary and still allow the user to change ACL as described in the installation manifest, if this is not desired.\n\n```\n[Service]\nReadWritePaths = /usr/share/webapps/matomo/config\nReadWritePaths = /usr/share/webapps/matomo/matomo.js\nReadWritePaths = /usr/share/webapps/matomo/misc/user/\nReadWritePaths = /usr/share/webapps/matomo/plugins/\n```\n\n"
    },
    {
      "title": "Server setup (nginx)",
      "level": 3,
      "content": "In order to enable php websites, install the php-fpm package and start/enable php-fpm.service (See Nginx#PHP implementation). Create the server by modifying /etc/nginx/nginx.conf. Add the following template to the \"http\" context. Alternatively, take a look at matomo's GitHub instructions.\n\n```\ninclude /etc/nginx/mime.types;\n\nserver\n{\n    index index.php;\n    listen 443 ssl;\n    listen [::]:443 ssl;\n    root /usr/share/webapps/matomo/;\n    server_name matomo.example.com;\n\n    location ~ ^/(\\.git/|config/|core/|lang/|tmp/)\n    {\n        return 403;\n    }\n\n    location ~ \\.php$\n    {\n        try_files $uri =404;\n\n        # FastCGI\n        include fastcgi.conf;\n        fastcgi_pass unix:/run/php-fpm/php-fpm.sock;\n        fastcgi_index index.php;\n    }\n\n    location ~ \\.(avi|css|eot|gif|htm|html|ico|jpg|js|json|mp3|mp4|ogg|png|svg|ttf|wav|woff|woff2)$\n    {\n        try_files $uri =404;\n    }\n\n    location ~ ^/(libs/|misc/|node_modules/|plugins/|vendor/)\n    {\n        return 403;\n    }\n}\n```\n\nTo use encryption, you can get free certificates from letsencrypt. After requesting and installing your certificates, use them by adding the following code to the \"http\" or \"server\" context:\n\n```\ninclude /etc/letsencrypt/options-ssl-nginx.conf;\nssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;\nssl_certificate_key /etc/letsencrypt/live/subdomain.domain.me/privkey.pem;\nssl_certificate /etc/letsencrypt/live/subdomain.domain.me/fullchain.pem;\n```\n\nRun the nginx server by starting/enabling nginx.service.\n\n"
    },
    {
      "title": "Final steps",
      "level": 3,
      "content": "All major settings are done. Call your Matomo website in your browser and complete the small installation guide which is not more than checking that everything needed is available and set up and writing your configuration file.\n\n"
    }
  ]
}