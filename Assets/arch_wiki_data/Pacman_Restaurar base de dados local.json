{
  "title": "Pacman/Restaurar base de dados local",
  "url": "https://wiki.archlinux.org/title/Pacman/Restaurar_base_de_dados_local",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Sinais de que o pacman precisa de uma restauração da base de dados local:\n\n- pacman -Q fornece absolutamente nenhuma saída e pacman -Syu relata erroneamente que o sistema está atualizado.\n- Ao tentar instalar um pacote usando pacman -S pacote e ele emite uma lista de dependências já satisfeitas.\n\nMuito provavelmente, a base de dados de softwares instalados do pacman, /var/lib/pacman/local, foi corrompida ou excluída. Embora este seja um problema sério, ele pode ser restaurado seguindo as instruções abaixo.\n\nPrimeiramente, certifique-se de que o arquivo de registro de logs do pacman está presente:\n\n```\n$ ls /var/log/pacman.log\n```\n\nSe não existe, não é possível continuar com este método. Você pode usar o script de detecção de pacotes do Xyne para recriar a base de dados. Caso contrário, a solução provável é reinstalar todo o sistema.\n\n"
    },
    {
      "title": "Gerando a lista de recuperação de pacotes",
      "level": 2,
      "content": "Instale o pacote pacutils para obter paclog.\n\nCrie um script de filtro de logs e torne-o executável:\n\n```\npacrecover\n```\n\n```\n#!/bin/bash -e\n\n. /etc/makepkg.conf\n\nPKGCACHE=$((grep -m 1 '^CacheDir' /etc/pacman.conf || echo 'CacheDir = /var/cache/pacman/pkg') | sed 's/CacheDir = //')\n\npkgdirs=(\"$@\" \"$PKGDEST\" \"$PKGCACHE\")\n\nwhile read -r -a parampart; do\n  pkgname=\"${parampart[0]}-${parampart[1]}-*.pkg.tar.{xz,zst}\"\n  for pkgdir in ${pkgdirs[@]}; do\n    pkgpath=\"$pkgdir\"/$pkgname\n    [ -f $pkgpath ] && { echo $pkgpath; break; };\n  done || echo ${parampart[0]} 1>&2\ndone\n```\n\nExecute o script (opcionalmente, passando diretórios adicionais com pacotes como parâmetros):\n\n```\n$ paclog --pkglist  --logfile=/var/log/pacman.log | ./pacrecover >files.list 2>pkglist.orig\n```\n\nDesta forma, serão criados dois arquivos: files.list com arquivos de pacote, ainda presentes na máquina e pkglist.orig, pacotes os quais devem ser baixados. A operação posterior pode resultar em incompatibilidade entre arquivos de versões mais antigas do pacote, ainda presentes na máquina e arquivos, encontrados na nova versão. Essas incompatibilidades terão de ser corrigidas manualmente.\n\nAqui está uma maneira de restringir automaticamente a segunda lista de pacotes disponíveis em um repositório:\n\n```\n$ { cat pkglist.orig; pacman -Slq; } | sort | uniq -d > pkglist\n```\n\nNote: **tente novamente o comando anterior** \n\nVerifique se algum pacotes importantes do base está em falta e adicione-o à lista:\n\n```\n$ comm -23 <(pacman -Sgq base | sort) pkglist.orig >> pkglist\n```\n\nProceda assim que o conteúdo de ambas listas seja satisfatório, já que elas serão usadas para restaurar a base de dados de pacotes instalados do pacman; /var/lib/pacman/local/.\n\n"
    },
    {
      "title": "Efetuando a recuperação",
      "level": 2,
      "content": "Defina uma função de bash para fins de recuperação:\n\n```\nrecovery-pacman() {\n    pacman \"$@\"  \\\n    --log /dev/null   \\\n    --noscriptlet     \\\n    --dbonly          \\\n    --overwrite \"*\"   \\\n    --nodeps          \\\n    --needed\n}\n```\n\n--log /dev/null permite evitar a poluição desnecessária do log do pacman; --needed economizará algum tempo ignorando pacotes, já presentes no banco de dados; --nodeps permitirá a instalação de pacotes em cache, mesmo que os pacotes instalados dependam de versões mais recentes. O restante das opções permitirá o pacman operar sem ler/escrever o sistema de arquivos.\n\nPopule a base de dados de sincronização:\n\n```\n# pacman -Sy\n```\n\nInicie a geração da base de dados instalando arquivos de pacotes disponíveis localmente de files.list:\n\n```\n# recovery-pacman -U $(< files.list)\n```\n\nInstale o resto de pkglist:\n\n```\n# recovery-pacman -S $(< pkglist)\n```\n\nAtualize a base de dados local para que os pacotes que não sejam exigidos por qualquer outro pacote sejam marcados como instalados explicitamente e os outros como dependências. Você precisará ser extremamente cuidadoso no futuro ao remover pacotes, mas com a base de dados original perdida é o melhor que podemos fazer.\n\n```\n# pacman -D --asdeps $(pacman -Qq)\n# pacman -D --asexplicit $(pacman -Qtq)\n```\n\nOpcionalmente, verifique todos os pacotes instalados por corrompimento:\n\n```\n# pacman -Qk\n```\n\nOpcionalmente, tente pacman/Dicas e truques#Identificar arquivos que pertençam a nenhum pacote.\n\nAtualize todos os pacotes:\n\n```\n# pacman -Su\n```\n\n"
    }
  ]
}