{
  "title": "Diretrizes de pacotes DKMS",
  "url": "https://wiki.archlinux.org/title/Diretrizes_de_pacotes_DKMS",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "32-bit – CLR – CMake – Cross – DKMS – Eclipse – Electron – Fonte – Free Pascal – GNOME – Go – Haskell – Java – KDE – Kernel – Lisp – Meson – MinGW – Node.js – Nonfree – OCaml – Perl – PHP – Python – R – Ruby – Rust – Shell – VCS – Web – Wine\n\nAqui estão algumas diretrizes para seguir ao criar um pacote DKMS.\n\n"
    },
    {
      "title": "Nome de pacote",
      "level": 2,
      "content": "Os pacotes DKMS são nomeados anexando \"-dkms\" ao nome do pacote original.\n\nA variável $_pkgname é frequentemente usada abaixo de $pkgname para descrever o nome do pacote menos o sufixo \"-dkms\" \"(por exemplo, _pkgname=${pkgname%-*}). Isso é útil para ajudar a manter semelhanças entre o pacote original PKGBUILD e a variante DKMS.\n\n"
    },
    {
      "title": "Dependências",
      "level": 2,
      "content": "As dependências devem ser herdadas da versão original com o dkms adicionado e o linux-headers removidos (como listado no pacote dkms como opcional).\n\n"
    },
    {
      "title": "Local de fontes de compilação",
      "level": 2,
      "content": "As fontes de compilação devem entrar (este é o diretório de compilação padrão do DKMS):\n\n```\n/usr/src/NOME_PACOTE-VERSÃO_PACOTE\n```\n\nNo diretório do pacote, uma configuração de DKMS informa ao DKMS como compilar o módulo (dkms.conf), incluindo as variáveis NOME_PACOTE e VERSÃO_PACOTE.\n\n- NOME_PACOTE - o nome real do projeto (geralmente $_pkgname ou $_pkgbase).\n- VERSÃO_PACOTE - por convenção, este também deve ser o $pkgver.\n\n"
    },
    {
      "title": "Correções",
      "level": 2,
      "content": "Pode-se aplicar patches corrigindo os fontes diretamente no PKGBUILD ou através de dkms.conf.\n\n"
    },
    {
      "title": "Carregamento de módulos automaticamente em .install",
      "level": 2,
      "content": "Carregar ou descarregar os módulos devem ser deixados para o usuário. Considere a possibilidade de um módulo travar ao ser carregado.\n\nAlém disso, observe que você não precisa chamar depmod explicitamente para atualizar as dependências do seu módulo do kernel. Agora, o pacman está chamando o dkms install e o dkms remove do DKMS automaticamente como ganchos (hooks). dkms install está certificando-se de que depmod seja chamado no final de seu processo. O dkms install depende do dkms build (para compilar o fonte no kernel atual), que depende do dkms add (para adicionar um link simbólico de /var/lib/dkms/<pacote>/<versão>/fonte para /usr/src/<pacote>).\n\n"
    },
    {
      "title": "Exemplo",
      "level": 2,
      "content": "Aqui está um exemplo de pacote que edita dkms.conf de acordo com o nome e a versão do pacote.\n\n"
    },
    {
      "title": "PKGBUILD",
      "level": 3,
      "content": "```\nPKGBUILD\n```\n\n```\n# Maintainer: foo <foo(at)example(dot)org>\n# Contributor: bar <bar(at)example(dot)org>\n\n_pkgbase=example\npkgname=example-dkms\npkgver=1\npkgrel=1\npkgdesc=\"The Example kernel modules (DKMS)\"\narch=('i686' 'x86_64')\nurl=\"https://www.example.org/\"\nlicense=('GPL2')\ndepends=('dkms')\nconflicts=(\"${_pkgbase}\")\ninstall=${pkgname}.install\nsource=(\"${url}/files/tarball.tar.gz\"\n        'dkms.conf'\n        'linux-3.14.patch')\nmd5sums=(use 'updpkgsums')\n\nprepare() {\n  cd ${_pkgbase}-${pkgver}\n\n  # Patch\n  patch -p1 -i \"${srcdir}\"/linux-3.14.patch\n\n}\n\npackage() {\n  # Install\n  make DESTDIR=\"${pkgdir}\" install\n\n  # Copy dkms.conf\n  install -Dm644 dkms.conf \"${pkgdir}\"/usr/src/${_pkgbase}-${pkgver}/dkms.conf\n\n  # Set name and version\n  sed -e \"s/@_PKGBASE@/${_pkgbase}/\" \\\n      -e \"s/@PKGVER@/${pkgver}/\" \\\n      -i \"${pkgdir}\"/usr/src/${_pkgbase}-${pkgver}/dkms.conf\n\n  # Copy sources (including Makefile)\n  cp -r ${_pkgbase}/* \"${pkgdir}\"/usr/src/${_pkgbase}-${pkgver}/\n}\n```\n\n"
    },
    {
      "title": "dkms.conf",
      "level": 3,
      "content": "```\ndkms.conf\n```\n\n```\nPACKAGE_NAME=\"@_PKGBASE@\"\nPACKAGE_VERSION=\"@PKGVER@\"\nMAKE[0]=\"make --uname_r=$kernelver\"\nCLEAN=\"make clean\"\nBUILT_MODULE_NAME[0]=\"@_PKGBASE@\"\nDEST_MODULE_LOCATION[0]=\"/kernel/drivers/misc\"\nAUTOINSTALL=\"yes\"\n```\n\n"
    },
    {
      "title": ".install",
      "level": 3,
      "content": "Agora, o pacman possui hooks de DKMS implementados. Você não precisa especificar a configuração específica do DKMS no seu arquivo .install. As chamadas para dkms install e dkms remove serão automáticas.\n\n"
    }
  ]
}