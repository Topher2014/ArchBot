{
  "title": "Stubby",
  "url": "https://wiki.archlinux.org/title/Stubby",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Related articles\n\n- Domain name resolution\n\nStubby is an application that acts as a local DNS Privacy stub resolver (using DNS-over-TLS). Stubby encrypts DNS queries sent from a client machine (desktop or laptop) to a DNS Privacy resolver, increasing end user privacy.\n\n"
    },
    {
      "title": "Installation",
      "level": 2,
      "content": "Install the stubby package.\n\n"
    },
    {
      "title": "Configuration",
      "level": 2,
      "content": "To configure stubby, perform the following steps:\n\n"
    },
    {
      "title": "Select resolver",
      "level": 3,
      "content": "Upon installation, Stubby has some default resolvers. They can be found and edited in /etc/stubby/stubby.yml. You can use the defaults, uncomment one of prewritten resolvers or find another resolver from this list.\n\nExample of a valid resolver configuration:\n\n```\n/etc/stubby/stubby.yml\n```\n\n```\nupstream_recursive_servers:\n\n# The Cloudflare server\n- address_data: 1.1.1.1\n    tls_port: 853\n    tls_auth_name: \"cloudflare-dns.com\"\n\n# The Surfnet/Sinodun servers\n - address_data: 145.100.185.15\n    tls_auth_name: \"dnsovertls.sinodun.com\"\n    tls_pubkey_pinset:\n      - digest: \"sha256\"\n        value: 62lKu9HsDVbyiPenApnc4sfmSYTHOVfFgL3pyB+cBL4=\n```\n\nWhen you get warn log complaining wrong tls_pubkey_pinset, the tls_pubkey_pinset value may be wrong and the value of the tls_pubkey_pinset can be generated with:\n\n```\n$ echo | openssl s_client -connect address_data:tls_port 2>/dev/null | openssl x509 -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64\n```\n\n"
    },
    {
      "title": "Modify resolv.conf",
      "level": 3,
      "content": "After selecting a resolver, modify the resolv.conf file and replace the current set of resolver addresses with address for localhost:\n\n```\n/etc/resolv.conf\n```\n\n```\nnameserverÂ ::1\nnameserver 127.0.0.1\noptions trust-ad\n```\n\nOther programs may overwrite this setting; see resolv.conf#Overwriting of /etc/resolv.conf for details.\n\n"
    },
    {
      "title": "Start systemd service",
      "level": 3,
      "content": "Finally, start/enable the stubby.service.\n\n"
    },
    {
      "title": "Local DNS cache configuration",
      "level": 3,
      "content": "Stubby does not have a built-in DNS cache, therefore every single query is transmitted and resolved, which can slow down connections. Setting up a DNS cache requires installing and configuring a separate DNS cacher.\n\n"
    },
    {
      "title": "Change port",
      "level": 4,
      "content": "In order to forward to a local DNS cache, Stubby should listen on a port different from the default 53, since the DNS cache itself needs to listen on 53 and query Stubby on a different port. Port number 54 is used as an example in this section.\n\nEdit the value of listen_addresses as follows:\n\n```\n/etc/stubby/stubby.yml\n```\n\n```\nlisten_addresses:\n  - 127.0.0.1@54\n  -  0::1@54\n```\n\nConfigure dnsmasq as a local DNS cache. The basic configuration to work with Stubby is the following:\n\n```\n/etc/dnsmasq.conf\n```\n\n```\nno-resolv\nproxy-dnssec\nserver=::1#54\nserver=127.0.0.1#54\nlisten-address=::1,127.0.0.1\n```\n\nRestart dnsmasq.service to apply the changes.\n\nFor more DNS cachers, see DNSCrypt#Local DNS cache configuration. The configurations should be similar if not identical.\n\n"
    }
  ]
}