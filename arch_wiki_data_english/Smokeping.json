{
  "title": "Smokeping",
  "url": "https://wiki.archlinux.org/title/Smokeping",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Smokeping allows you to probe a list of servers, store that data using RRDtool, and generate statistical charts based on RRDtool's output. Smokeping consists of two parts. A daemon runs in the background pinging and collecting data at set intervals. A web interface displays that data in the form of graphs.\n\nThis wiki page covers a basic setup of the smokeping daemon and the CGI webinterface.\n\n"
    },
    {
      "title": "Installation",
      "level": 2,
      "content": "This section covers the installation of Smokeping using the smokeping package. FastCGI on Apache will be setup as described in Apache and FastCGI.\n\nThe smokeping package consists of two parts:\n\n- The smokeping daemon and configs in /etc/smokeping/. This daemon performs the monitoring.\n- The smokeping \"htdocs\" in /srv/http/smokeping. These will be used by the web interface.\n\nIn addition to the smokeping package, you will need:\n\n- A tool that smokeping can use for monitoring. fping is the simplest and default method for simple ping probes.\n- apache and mod_fcgidAUR for the web interface if you are using Apache.\n- fcgiwrap and start and enable fcgiwrap.socket if you are using Nginx\n- An image cache directory that the FastCGI script can write to, e.g. /srv/smokeping/imgcache\n- A data directory that the smokeping daemon can write to, and the FastCGI script can read, e.g. /srv/smokeping/data\n- To ensure that the main configuration file is readable by the smokeping daemon.\n\n"
    },
    {
      "title": "Optional Prerequisites",
      "level": 3,
      "content": "If you want to use other probes such as the DNS or http probe you will need other packages as shown below. The configuration of these will is not covered by this wiki page.\n\nTable content:\nProbe | Package Needed\nCurl | curl\nDNS | bind (for the dig utility)\nEchoPing | echopingAUR\nSSH | openssh\nTelnetIOSPing | perl-net-telnet\nAnotherDNS | perl-net-dns\nLDAP | perl-ldap\nLDAP (tls) | perl-io-socket-ssl\nAuthen | perl-authen-radius\n\n"
    },
    {
      "title": "Configuration",
      "level": 2,
      "content": "Smokeping requires you to edit a few files. The unedited files end with the .dist extension. Rename the .dist files in /etc/smokeping to remove the suffix. The find command does this and prints out each file that is being renamed and needs editing:\n\n```\n# cd /etc/smokeping\n# find . -name '*.dist' -print -execdir sh -c 'mv {} $(basename {} .dist)' \\;\n# mv /srv/http/smokeping/smokeping.fcgi.dist /srv/http/smokeping/smokeping.fcgi\n```\n\n"
    },
    {
      "title": "Editing the configuration file",
      "level": 3,
      "content": "Next, edit the /etc/smokeping/config file; this is smokeping's main configuration file. A brief description of the sections is followed by a complete example.\n\nNote: most paths need changing, potentially from /usr/etc/ to /etc/smokeping, but confirm each one. Paths for the various .dist files can be found with pacman -Ql smokeping\n\nThe General section of the /etc/smokeping/config file is the easiest to edit. Personalize the top of the configuration file to match your information. The comments describe each field. Note that if you do not have the sendmail program installed (ie from postfix or sendmail) then use something else instead like /bin/false. The file you specify must exist or smokeping will error out.\n\nThe Alerts section does not require any changes for this example.\n\nThe Database section does not require any changes.\n\nIn the Presentation section the path to the template filename needs to be updated, (ie /etc/smokeping/basepage.html)\n\nThe Probes section specifies which probes are active. By default only the FPing probe is enabled. This section does not require any changes.\n\nThe Slaves section is not needed in this minimal example, so it can be either commented out or removed. Note that if you use the smokeping_secrets setting in the Slaves section, you will have to make that file unreadable to the rest of the world, or else smokeping will error: chmod 600 /etc/smokeping/smokeping_secrets.\n\nThe Targets section specifies which hosts will be probed (pinged in our example). Customize it so that it probes the host(s) you would like to collect statistics on, as shown in the example below.\n\nYou can learn more about the Smokeping configuration file with the examples at https://oss.oetiker.ch/smokeping/doc/smokeping_examples.en.html\n\n```\n/etc/smokeping/config\n```\n\n```\n*** General ***\n\nowner     = Your Name Here                            # your name\ncontact   = your.email@host.bla                       # your email\nmailhost  = your.smtp.server.bla                      # your mail server\nsendmail  = /bin/false                                # where the sendmail program is\nimgcache  = /srv/smokeping/imgcache                   # filesystem directory where we store files\nimgurl    = imgcache                                  # URL directory to find them\ndatadir   = /srv/smokeping/data                       # where we share data between the daemon & webapp\npiddir    = /var/run                                  # filesystem directory to store PID file\ncgiurl    = http://localhost/smokeping/smokeping.fcgi  # exterior URL\nsmokemail = /etc/smokeping/smokemail   \ntmail     = /etc/smokeping/tmail\nsyslogfacility = local0\n# each probe is now run in its own process\n# disable this to revert to the old behaviour\n# concurrentprobes = no\n\n*** Alerts ***\nto = alertee@address.somewhere\nfrom = smokealert@company.xy\n\n+someloss\ntype = loss\n# in percent\npattern = >0%,*12*,>0%,*12*,>0%\ncomment = loss 3 times  in a row\n\n*** Database ***\n\nstep     = 300\npings    = 20\n\n# consfn mrhb steps total\n\nAVERAGE  0.5   1  1008\nAVERAGE  0.5  12  4320\n    MIN  0.5  12  4320\n    MAX  0.5  12  4320\nAVERAGE  0.5 144   720\n    MAX  0.5 144   720\n    MIN  0.5 144   720\n\n*** Presentation ***\n\ntemplate = /etc/smokeping/basepage.html\n\n+ charts\n\nmenu = Charts\ntitle = The most interesting destinations\n++ stddev\nsorter = StdDev(entries=>4)\ntitle = Top Standard Deviation\nmenu = Std Deviation\nformat = Standard Deviation %f\n\n++ max\nsorter = Max(entries=>5)\ntitle = Top Max Roundtrip Time\nmenu = by Max\nformat = Max Roundtrip Time %f seconds\n\n++ loss\nsorter = Loss(entries=>5)\ntitle = Top Packet Loss\nmenu = Loss\nformat = Packets Lost %f\n\n++ median\nsorter = Median(entries=>5)\ntitle = Top Median Roundtrip Time\nmenu = by Median\nformat = Median RTT %f seconds\n\n+ overview \n\nwidth = 600\nheight = 50\nrange = 10h\n\n+ detail\n\nwidth = 600\nheight = 200\nunison_tolerance = 2\nnodata_color = ffb0b0\nloss_background = yes\n\n\"Last 3 Hours\"    3h\n\"Last 30 Hours\"   30h\n\"Last 10 Days\"    10d\n\"Last 400 Days\"   400d\n\n*** Probes ***\n\n+ FPing\n\nbinary = /usr/bin/fping\n\n*** Targets ***\n\nprobe = FPing\n\nmenu = Top\ntitle = Network Latency Grapher\nremark = Welcome to the SmokePing website of Arch User. \\\n         Here you will learn all about the latency of our network.\n\n+ targets\nmenu = Targets\ntitle = Targets\n\n++ CloudflareDNS\n \nmenu = Cloudflare DNS\ntitle = Cloudflare DNS server\nhost = 1.1.1.1\n\n++ GoogleDNS\n\nmenu = Google DNS\ntitle = Google DNS server\nhost = 8.8.8.8\n\n++ MultiHost\n\nmenu = Multihost example\ntitle = CloudflareDNS and Google DNS\nhost = /targets/CloudflareDNS /targets/GoogleDNS\n```\n\n"
    },
    {
      "title": "Notes on the smokeping configuration file syntax",
      "level": 4,
      "content": "Each + character defines a section in the hierarchy. Spaces are not allowed in the section names. Period and forward slashes should probably also be avoided in section names. This is probably because the RRD files are stored under the data directory with the same exact names as the sections.\n\nIn the Targets section, you can define host as either a real host name or the path to another section to generate a multiple host chart, as shown in the MultiHost example above.\n\n"
    },
    {
      "title": "Setup the rest of the system",
      "level": 3,
      "content": "Setup the extra directories referenced by the configuration file:\n\n```\n# mkdir -p /srv/smokeping/data\n# mkdir -p /srv/smokeping/imgcache\n# chown -R smokeping:smokeping /srv/smokeping\n# chown -R http:http /srv/smokeping/imgcache\n# chmod a+rx /srv/smokeping\n# chmod -R a+rx /srv/smokeping/data\n```\n\nSince the smokeping configuration is read by both the smokeping daemon and the FastCGI scripts, so it needs to be readable:\n\n```\n# chmod a+rx /etc/smokeping\n# chmod a+r /etc/smokeping/config\n```\n\n"
    },
    {
      "title": "Notes on Smokeping in Master Slave configuration",
      "level": 4,
      "content": "A master-slave has one additional wrinkle, though the principles are the same. For slaves, smokeping IS NOT writing the data to the RRD files - they're getting pushed there by the web-server. So, in master-slave mode you need to be sure that the user your web-server is running as [nginx running as user http] also has WRITE permissions to the RRD files (under /srv/smokeping/data).\n\nWhen running Smokeping in Master / Slave mode, the master has effective permissions of the user the smokeping slave runs as. Do NOT run slaves as root. Read the security considerations first.\n\nThe Smokeping FAQ on their wiki details the complex permission requirements. If your master slave config is still not working, use setfacl to provide the minimum required permissions:\n\n```\nOn the master, give both `http` and `smokeping` full access (rwx) to `/srv/smokeping/*`\n# setfacl -R -m u:http:rwx /srv/smokeping\n# setfacl -R -m u:smokeping:rwx /srv/smokeping\n\nSet specific read permissions for files inside `/etc/smokeping`\n# setfacl -m u:http:r /etc/smokeping/smokeping_secrets\n# setfacl -m u:smokeping:r /etc/smokeping/config /etc/smokeping/smokeping_secrets\n```\n\nSlaves require no config file, they pull their config from the master, and just need to read /etc/smokeping/smokeping_secrets:\n\n```\n# /usr/bin/smokeping --master-url=https://smokeping.site/smokeping.fcgi\n# setfacl -m u:http:r /etc/smokeping/smokeping_secrets\n```\n\nA sample slave's systemd unit:\n\n```\n[Unit]\nDescription=Smokeping Slave: my.slave.net\nDocumentation=man:smokeping_master_slave(7)\n\n[Service]\nExecStart=/usr/sbin/smokeping \\\n  --master-url=https://smokeping.site/smokeping.fcgi \\\n  --cache-dir=/var/lib/smokeping \\\n  --shared-secret=/etc/smokeping/smokeping_secrets \\\n  --pid-dir=/run/smokeping \\\n  --slave-name=my.slave.net \n# The --slave-name should be an exact match to both the master's config and smokeping_secrets\n  \nExecReload=/bin/kill -HUP $MAINPID  \n\n[Service]\nType=forking\nRuntimeDirectory=smokeping\nPIDFile=/run/smokeping/smokeping.pid\nUser=smokeping\nGroup=smokeping\nRestart=on-failure\n```\n\n"
    },
    {
      "title": "Start and enable daemon",
      "level": 3,
      "content": "Start and enable smokeping.service. Then check that it is running.\n\n"
    },
    {
      "title": "Apache",
      "level": 3,
      "content": "Edit /etc/httpd/conf/httpd.conf so that it includes:\n\n```\nLoadModule fcgid_module modules/mod_fcgid.so\n<IfModule fcgid_module>\n  AddHandler fcgid-script .fcgi\n</IfModule>\n\nAlias /smokeping/imgcache /srv/smokeping/imgcache\nAlias /smokeping /srv/http/smokeping\n\n<Directory \"/srv/smokeping/imgcache\">\n  AllowOverride all\n  Require all granted\n</Directory>\n\n<Directory \"/srv/http/smokeping\">\n Options FollowSymLinks ExecCGI\n AllowOverride all\n Require all granted\n</Directory>\n```\n\nStart Apache via the httpd.service.\n\nCheck that http://localhost/smokeping/smokeping.fcgi loads. The first data should appear after a couple of minutes.\n\nIf the fonts in the graphs are unreadable, you may need to install the ttf-dejavu package.\n\n"
    },
    {
      "title": "Caddy",
      "level": 3,
      "content": "Thanks to the Caddy community and with this configuration file /etc/smokeping/config and with enable fcgiwrap.socket\n\n```\n/etc/caddy/caddy.conf.d/smokeping.conf\n```\n\n```\nsmokeping.example.com {\n\n        log stdout\n        errors\n\n        tls john@example.com\n        root /srv/http/smokeping\n\n        fastcgi / unix:/var/run/fcgiwrap.sock {\n                env SCRIPT_FILENAME /srv/http/smokeping/smokeping.fcgi.dist\n        }\n}\n\nsmokeping.example.com/js {\n        root /srv/http/smokeping/js\n}\n\nsmokeping.example.com/css {\n        root /srv/http/smokeping/css\n}\n\nsmokeping.example.com/cache {\n        root /var/cache/smokeping\n}\n```\n\nAn updated version of this Caddy configuration for smokeping - https://gist.github.com/Strykar/4df1eb8aebc4d5f7039f6045301352c7\n\n"
    },
    {
      "title": "Caddy 2",
      "level": 3,
      "content": "Thanks to the francislavoie and Caddy community and to the Caddy docs. Start and enable fcgiwrap.socket!\n\n```\n/etc/caddy/caddy.conf.d/smokeping.conf\n```\n\n```\nsmokeping.example.com {\n\n    handle /js/* {\n        root * /srv/http/smokeping/\n        file_server\n    }\n    handle /css/* {\n        root * /srv/http/smokeping/\n        file_server\n    }\n    handle /imgcache/* {\n        root * /srv/http/smokeping/\n        file_server\n    }\n    handle /images/* {\n        root * /srv/http/smokeping/\n        file_server\n    }\n    \n    handle {\n        root * /srv/http/smokeping/\n        reverse_proxy unix//var/run/fcgiwrap.sock {\n            transport fastcgi {\n                env SCRIPT_FILENAME /srv/http/smokeping/smokeping.fcgi\n                split \"\"\n            }\n        }\n    }\n}\n```\n\n"
    },
    {
      "title": "Lighttpd",
      "level": 3,
      "content": "First install lighttpd and fcgi.\n\nEdit the Lighttpd configuration file and ensure you have at least all of the following configuration directives:\n\n```\n/etc/lighttpd/lighttpd.conf\n```\n\n```\nserver.document-root    = \"/srv/http\"\nserver.follow-symlink   = \"enable\"\n\nserver.modules += (\"mod_fastcgi\")\nfastcgi.server = (\n        \".fcgi\" =>\n        ((\n                \"bin-path\" => \"/srv/http/smokeping/smokeping.fcgi\",\n                \"host\" => \"localhost\",\n                \"port\" => 8001,\n        )),\n)\n```\n\nStart/enable the lighttpd.service\n\nSystemd should show smokeping_cgi being managed by lighttpd.service.\n\n```\n$ systemctl status lighttpd\n```\n\n```\n● lighttpd.service - Lighttpd Web Server\n   Loaded: loaded (/usr/lib/systemd/system/lighttpd.service; enabled; vendor preset: disabled)\n   Active: active (running) since Wed 2018-12-26 14:34:42 PST; 1 day 7h ago\n  Process: 17117 ExecReload=/bin/kill -HUP $MAINPID (code=exited, status=0/SUCCESS)\n Main PID: 28321 (lighttpd-angel)\n    Tasks: 6 (limit: 4915)\n   Memory: 128.9M\n   CGroup: /system.slice/lighttpd.service\n           ├─17119 /usr/bin/lighttpd -D -f /etc/lighttpd/lighttpd.conf\n           ├─17126 /usr/bin/perl /usr/bin/smokeping_cgi /etc/smokeping/config\n           ├─17127 /usr/bin/perl /usr/bin/smokeping_cgi /etc/smokeping/config\n           ├─17128 /usr/bin/perl /usr/bin/smokeping_cgi /etc/smokeping/config\n           ├─17129 /usr/bin/perl /usr/bin/smokeping_cgi /etc/smokeping/config\n           └─28321 /usr/bin/lighttpd-angel -D -f /etc/lighttpd/lighttpd.conf\n```\n\nFinally, add a symbolic link to allow images to load:\n\n```\n# ln -s -t /srv/http/smokeping /srv/smokeping/imgcache\n```\n\n"
    },
    {
      "title": "Nginx",
      "level": 3,
      "content": "Ensure that fcgiwrap.socket and nginx.service are both running via systemctl.\n\nAdd a server block for smokeping to /etc/nginx/nginx.conf, following is an example for a TLS enabled block.\n\n```\nserver {\n       server_name smokeping.example.com;\n       listen 443 ssl http2;\n       listen [::]:443 ssl http2;\n       root /srv/http/smokeping/;\n       index smokeping.fcgi;\n       gzip off;\n       access_log /var/log/nginx_smokeping.log combined;\n       error_log /var/log/nginx_smokeping.log;\n       location ~ \\.fcgi$ {\n           fastcgi_intercept_errors on;\n           include /etc/nginx/fastcgi_params;\n           fastcgi_param SCRIPT_FILENAME /srv/http/smokeping/smokeping.fcgi;\n           fastcgi_pass unix:/var/run/fcgiwrap.sock;\n       }\n       location ^~ /imgcache {\n           alias /srv/smokeping/imgcache;\n           gzip off;\n       }\n   }\n```\n\nVerify that your configuration is fine via nginx -t as the root user and reload the configuration via nginx -s reload as the root user.\n\n"
    },
    {
      "title": "Advanced Configuration",
      "level": 2,
      "content": "Smokeping is a powerful tool that can be configured in many ways. You can setup many different types of probes. You can setup slave smokeping servers that can send their statistics and show you probes from other servers.\n\nYou can also create your custom probes in perl, see some third-party probes on their wiki. These options are currently not covered by this guide, please consult the documentation on the Smokeping website instead.\n\nAlso see - https://github.com/oetiker/SmokePing/wiki/FAQ\n\n"
    },
    {
      "title": "Smoketrace (Tr.cgi)",
      "level": 3,
      "content": "The SmokeTraceroute utility is gone since v2.5.0 according to the release notes.\n\n"
    }
  ]
}