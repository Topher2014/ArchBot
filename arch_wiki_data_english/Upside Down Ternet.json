{
  "title": "Upside Down Ternet",
  "url": "https://wiki.archlinux.org/title/Upside_Down_Ternet",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "This article explains how to create a transparent Squid proxy server using imagemagick's mogrify to flip the images upside down.\n\n"
    },
    {
      "title": "Installation",
      "level": 2,
      "content": "Install the squid, apache, wget and imagemagick packages.\n\n"
    },
    {
      "title": "Configuration",
      "level": 2,
      "content": "Create flip.pl, place it in your /usr/local/bin folder and make it executable:\n\n```\n/usr/local/bin/flip.pl\n```\n\n```\n#!/usr/bin/perl\n$|=1;\n$count = 0;\n$pid = $$;\nwhile (<>) {\n       @splitted=split(/ /,$_);\n       chomp $_;\n       if ($_ =~ /(.*\\.jpg)/i) {\n               $url = $1;\n               system(\"/usr/bin/wget\", \"-q\", \"-O\",\"/srv/http/images/$pid-$count.jpg\", \"$url\");\n               system(\"/usr/bin/mogrify\", \"-flip\",\"/srv/http/images/$pid-$count.jpg\");\n               print \"http://127.0.0.1/images/$pid-$count.jpg\\n\";\n       }\n       elsif ($_ =~ /(.*\\.gif)/i) {\n               $url = $1;\n               system(\"/usr/bin/wget\", \"-q\", \"-O\",\"/srv/http/images/$pid-$count.gif\", \"$url\");\n               system(\"/usr/bin/mogrify\", \"-flip\",\"/srv/http/images/$pid-$count.gif\");\n               print \"http://127.0.0.1/images/$pid-$count.gif\\n\";\n       }\n       elsif ($_ =~ /(.*\\.png)/i) {\n               $url = $1;\n               system(\"/usr/bin/wget\", \"-q\", \"-O\",\"/srv/http/images/$pid-$count.png\", \"$url\");\n               system(\"/usr/bin/mogrify\", \"-flip\",\"/srv/http/images/$pid-$count.png\");\n               print \"http://127.0.0.1/images/$pid-$count.png\\n\";\n       }\n       else {\n               print \"$splitted[0]\\n\";\n       }\n       $count++;\n}\n```\n\nNext, while not necessary, does clean up the Squid configuration file a lot making it easier on the eyes\n\n```\n# sed -i \"/^#/d;/^ *$/d\" /etc/squid/squid.conf\n```\n\nNow, edit your squid.conf file and append this to the bottom\n\n```\nsquid.conf\n```\n\n```\nurl_rewrite_program /usr/local/bin/flip.pl\n```\n\nAlso find the line for http_port and make it now read\n\n```\nsquid.conf\n```\n\n```\nhttp_port 3128 intercept\n```\n\nFinally, we have to create the folders for the images to be flipped in and set their permissions\n\nThe directory where the images are to be stored must be owned by the proxy user.\n\n```\n# mkdir /srv/http/images\n# chown proxy:proxy /srv/http/images\n# chmod 755 /srv/http/images\n```\n\nFinally, add the http user to the proxy group\n\n```\n# usermod -aG proxy http\n```\n\nVerify that the http user is a member of the proxy group\n\n```\n# groups http\n```\n\nor\n\n```\n# id -Gn http\n```\n\n"
    },
    {
      "title": "Router setup",
      "level": 3,
      "content": "You will need to edit the firewall on your router or gateway to redirect HTTP traffic to your proxy.\n\n"
    },
    {
      "title": "Starting",
      "level": 2,
      "content": "Start/enable httpd.service and squid.service.\n\n"
    },
    {
      "title": "See also",
      "level": 2,
      "content": "- Original Upside-Down-Ternet\n- Ubuntu HowTo\n- Transparent Proxy with DD-WRT\n- Upside-Down-Ternet XKCD\n\n"
    }
  ]
}