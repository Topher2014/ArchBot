{
  "title": "PCI passthrough via OVMF/Examples",
  "url": "https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF/Examples",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "As PCI passthrough is quite tricky to get right (both on the hardware and software configuration sides), this page presents working, complete VFIO setups. Feel free to look up users' scripts, BIOS/UEFI configuration, configuration files and specific hardware. If you have a problem, it might have been stumbled upon by other VFIO users and fixed in the examples below.\n\n"
    },
    {
      "title": "mstrthealias: Intel 7800X / X299, GTX 1070",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel(R) Core(TM) i7-7800X CPU\n- Motherboard: ASRock X299 Taichi (Revision: A, BIOS/UEFI Version: 1.60A)\n- GPU: Asus STRIX GTX 1070\n- RAM: 32GB DDR4\n\nConfiguration:\n\n- Kernel: Kernel version 4.14.8-1-skx (patched crystal_khz=24000). Custom patches: skylakex-crystal_khz-24000.patch (see below) Patches used from linux-ck: enable_additional_cpu_optimizations_for_gcc_v4.9+_kernel_v4.13+.patch 0001-add-sysctl-to-disallow-unprivileged-CLONE_NEWUSER-by.patch 0001-e1000e-Fix-e1000_check_for_copper_link_ich8lan-retur.patch 0002-dccp-CVE-2017-8824-use-after-free-in-DCCP-code.patch Config: PREEMPT, NO_HZ_IDLE, 300HZ, MSKYLAKE\n- GitHub: Link TBD\n- Benchmarks: https://imgur.com/a/hIfQD\n- Using libvirt/QEMU: libvirt 3.10.0 / QEMU 2.11.0\n- Issues you have encountered, special steps taken to make something work a bit better, etc. Skylake-X default clock incorrect in 4.14.8 (https://bugzilla.kernel.org/show_bug.cgi?id=197299) Was unable to resolve timing issue using adjtimex Patching kernel source to crystal_khz = 24000 resolved timing/performance issues Enable 'Intel SpeedShift' in BIOS, installed cpupower', set governor='performance' Verify: Run dmesg | grep HWP as root intel_pstate: HWP enabled Enable HT in BIOS Enable 'deadline' IO sceduler: echo 'ACTION==\"add|change\", KERNEL==\"sd*[!0-9]|sr*\", ATTR{queue/scheduler}=\"deadline\"' >> /etc/udev/rules.d/60-schedulers.rules Bypass x2apic opt-out: GRUB_CMDLINE_LINUX=\"... intremap=no_x2apic_optout ...\" Isolate cores for Windows VM: GRUB_CMDLINE_LINUX=\"... isolcpus=2-5,8-11 nohz_full=2-5,8-11 rcu_nocbs=2-5,8-11 ...\" Use hugepages (2MB) for all VM memory allocation memoryBacking: <hugepages/><nosharepages/><locked/><access mode='private'/><allocation mode='immediate'/> Extracted rom from GPU; used for <rom file=../> config Using MSI for GPU and GPU Audio (configured in Windows registry; FPS seems same as using line-based interrupts)\n- Hardware setup PCIE1: NVIDIA GeForce GT 710B (for host) Onboard: ASRock XHCI 3.1 USB (for host) Onboard: Intel I219 NIC (bridged) PCIE3: Asus Xonar STX (passthrough to Win10) PCIE5: NVIDIA GeForce GTX 1070 (passthrough to Win10) M2_1: Samsung 960 EVO 500GB (passthrough to Win10) Onboard: Intel XHCI USB 3.0 (passthrough to Win10) Onboard: Intel HDA (passthrough to Win10) Onboard: Intel I211 NIC (passthrough to Win10) Onboard: ASRock AHCI SATA A1/A2 (passthrough to Linux)\n\n- Custom patches: skylakex-crystal_khz-24000.patch (see below)\n- Patches used from linux-ck: enable_additional_cpu_optimizations_for_gcc_v4.9+_kernel_v4.13+.patch 0001-add-sysctl-to-disallow-unprivileged-CLONE_NEWUSER-by.patch 0001-e1000e-Fix-e1000_check_for_copper_link_ich8lan-retur.patch 0002-dccp-CVE-2017-8824-use-after-free-in-DCCP-code.patch\n- Config: PREEMPT, NO_HZ_IDLE, 300HZ, MSKYLAKE\n\n- skylakex-crystal_khz-24000.patch (see below)\n\n- enable_additional_cpu_optimizations_for_gcc_v4.9+_kernel_v4.13+.patch\n- 0001-add-sysctl-to-disallow-unprivileged-CLONE_NEWUSER-by.patch\n- 0001-e1000e-Fix-e1000_check_for_copper_link_ich8lan-retur.patch\n- 0002-dccp-CVE-2017-8824-use-after-free-in-DCCP-code.patch\n\n- PREEMPT, NO_HZ_IDLE, 300HZ, MSKYLAKE\n\n- Skylake-X default clock incorrect in 4.14.8 (https://bugzilla.kernel.org/show_bug.cgi?id=197299) Was unable to resolve timing issue using adjtimex Patching kernel source to crystal_khz = 24000 resolved timing/performance issues\n- Enable 'Intel SpeedShift' in BIOS, installed cpupower', set governor='performance' Verify: Run dmesg | grep HWP as root intel_pstate: HWP enabled\n- Enable HT in BIOS\n- Enable 'deadline' IO sceduler: echo 'ACTION==\"add|change\", KERNEL==\"sd*[!0-9]|sr*\", ATTR{queue/scheduler}=\"deadline\"' >> /etc/udev/rules.d/60-schedulers.rules\n- Bypass x2apic opt-out: GRUB_CMDLINE_LINUX=\"... intremap=no_x2apic_optout ...\"\n- Isolate cores for Windows VM: GRUB_CMDLINE_LINUX=\"... isolcpus=2-5,8-11 nohz_full=2-5,8-11 rcu_nocbs=2-5,8-11 ...\"\n- Use hugepages (2MB) for all VM memory allocation\n- memoryBacking: <hugepages/><nosharepages/><locked/><access mode='private'/><allocation mode='immediate'/>\n- Extracted rom from GPU; used for <rom file=../> config\n- Using MSI for GPU and GPU Audio (configured in Windows registry; FPS seems same as using line-based interrupts)\n\n- Was unable to resolve timing issue using adjtimex\n- Patching kernel source to crystal_khz = 24000 resolved timing/performance issues\n\n- Verify: Run dmesg | grep HWP as root intel_pstate: HWP enabled\n\n- intel_pstate: HWP enabled\n\n- echo 'ACTION==\"add|change\", KERNEL==\"sd*[!0-9]|sr*\", ATTR{queue/scheduler}=\"deadline\"' >> /etc/udev/rules.d/60-schedulers.rules\n\n- GRUB_CMDLINE_LINUX=\"... intremap=no_x2apic_optout ...\"\n\n- GRUB_CMDLINE_LINUX=\"... isolcpus=2-5,8-11 nohz_full=2-5,8-11 rcu_nocbs=2-5,8-11 ...\"\n\n- PCIE1: NVIDIA GeForce GT 710B (for host)\n- Onboard: ASRock XHCI 3.1 USB (for host)\n- Onboard: Intel I219 NIC (bridged)\n- PCIE3: Asus Xonar STX (passthrough to Win10)\n- PCIE5: NVIDIA GeForce GTX 1070 (passthrough to Win10)\n- M2_1: Samsung 960 EVO 500GB (passthrough to Win10)\n- Onboard: Intel XHCI USB 3.0 (passthrough to Win10)\n- Onboard: Intel HDA (passthrough to Win10)\n- Onboard: Intel I211 NIC (passthrough to Win10)\n- Onboard: ASRock AHCI SATA A1/A2 (passthrough to Linux)\n\n"
    },
    {
      "title": "DragoonAethis: 6700K, GA-Z170X-UD3, GTX 1070",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i7-6700K (using iGPU as the host GPU)\n- Motherboard: Gigabyte GA-Z170X-UD3 (Revision 1.0, BIOS/UEFI Version: F23d)\n- GPU: MSI GeForce 1070 Gaming X (10Gbps)\n- RAM: 16GB DDR4 2400MHz\n\nConfiguration:\n\n- Kernel: \"Vanilla\" Linux (no ACS patch needed).\n- Using libvirt: XML domain, helper scripts, IOMMU groups, etc available in my VFIO repository.\n- Guest OS: Windows 8.1 Pro.\n- The entire HDD is passed to the VM as a raw device (formatted as a single NTFS partition).\n- USB keyboard and mouse are passed to the guest VM and shared with the host with Synergy.\n- Virtualized audio: PulseAudio -> local Unix socket. Previously, I have had a bit more complex setup in which PA on the host was configured to accept TCP connections, and the environment variables required for QEMU to use PA were pointed at the PA server running on 127.0.0.1. This way it was not required to change the QEMU user (exact details in the repository), but introduced other minor issues I have resolved later.\n- Bridged networking (with NetworkManager's and this tutorial's help) is used. bridge0 is created, eth0 interface is bound to it. STP disabled, VirtIO NIC is configured in the VM and that VM is seen in the network just as any other computer (and is being assigned an IP address from the router itself, can communicate freely with other computers).\n- For some reason, enabling intel_iommu=on on the kernel command line without CSM support enabled in UEFI causes a black screen on boot. Enable it (Windows 8/10 features need to be enabled to show \"CSM Support\", selecting \"Other OS\" hides that).\n\n"
    },
    {
      "title": "Manbearpig3130's Original Virtual Gaming Machine",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i7-6850K 3.6GHz\n- Motherboard: Gigabyte x99-Ultra Gaming (Revision 1.0, BIOS/UEFI Version: F4)\n- Host GPU: AMD Radeon HD6950 1GB\n- Guest GPU: AMD R9 390 8GB\n- RAM: 32GB G-Skill Ripjaws DDR4 running at 3200MHz\n\nConfiguration:\n\n- Host Kernel: Kernel version Linux 4.7.2-1.\n- Using libvirt QEMU/KVM with OVMF: link to domain XMLs/scripts/notes: https://github.com/manbearpig3130/MBP-VT-d-gaming-machine\n- Host OS: Arch Linux\n- Guest OS: Windows 10 Pro\n- 2x 480GB SSDs set up in LVM striped mode (with mdadm) formatted to ext4 are mounted in linux which contains the guest's qcow2 virtual VirtIO disk file.\n- USB Host controller is passed through, giving most USB ports to the VM, leaving my USB 3.1 controller with attached USB hub for the host.\n- Motherboard has two NICs, one is passed into VM (Works perfectly after installing Killer NIC Driver).\n- VM gets dedicated 16GB RAM via static hugepages.\n- CPU pinning increased performance considerably.\n- Windows boots straight into Steam big picture mode on primary display (43\" Sony Bravia). Overall an awesome gaming machine that meets my gaming needs and wants for GNU/Linux at the same time.\n\nQuirks:\n\n- I sometimes have to reinstall the AMD drivers in Windows to get HDMI audio working properly, or roll back to Windows HDMI driver. I normally use a USB headset which works fine anyway.\n\n"
    },
    {
      "title": "Manbearpig3130's Evolved Virtual Gaming Machine",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i7-6850K 3.6GHz\n- Motherboard: Gigabyte x99-Ultra Gaming (Revision 1.0, BIOS/UEFI Version: F4)\n- Host GPU: AMD Radeon R9 390\n- Guest GPU: Nvidia 2080ti\n- RAM: 32GB G-Skill Ripjaws DDR4 running at 3200MHz\n\nConfiguration:\n\n- Host Kernel: Kernel version Linux 5.3.12-arch1-1\n- Using libvirt QEMU/KVM with OVMF: link to domain XMLs/scripts/notes: https://github.com/manbearpig3130/MBP-VT-d-gaming-machine\n- Host OS: Arch Linux\n- Guest OS: Windows 10 Pro\n- 2TB Intel 660P NVMe SSD passed through as storage. This needed a firmware update (sm2262 chipset) to pass through properly, but now that it works I also have the option to boot directly into Windows exclusively if I want to\n- USB Host controller is passed through, giving most USB ports to the VM, leaving my USB 3.1 controller with attached USB hub for the host.\n- Motherboard has two NICs, one is passed into VM (Works perfectly after installing Killer NIC Driver).\n- VM gets dedicated 16GB RAM via static hugepages.\n- CPU pinning increased performance considerably.\n- Windows boots straight into Steam big picture mode on primary display.\n- Intel 9260 Wi-Fi + Bluetooth M.2 card passed through for Xbox Series X/S controller\n- Valve Index VR headset works perfectly in VM\n\nQuirks:\n\n- I have issues with one of my USB controllers, it seems like it stutters or resets. I can mitigate this by plugging devices into other USB busses, such as that on the 2080ti and also my USB 3.1 bus. This problem only occues in Windows. I originally thought it was due to it being in a VM, but since I set up my NVMe passthrough and can boot into Windows directly now I still have the same problem. Does not happen at all on Linux\n\n"
    },
    {
      "title": "Bretos' Virtual Gaming Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i7-7700k\n- Motherboard: Z270 GAMING M3 (MS-7A62)\n- GPU: ASUS GeForce GTX960\n- RAM: Kingston HyperX 3x8GB DDR4 2.4GHz\n- Storage: 2x Corsair MP500 m.2 240G SSDs in mdadm RAID0, 1x WD Black 1TB for storage. 100GB LVM volume as writeback cache for HDD\n\nConfiguration:\n\n- Kernel: vanilla\n- Host OS: Arch Linux\n- Guest OS: Windows 10 Pro\n- Using libvirt/QEMU: GitHub config repository: [1]\n- Issues you have encountered: AUDIO. Had to get USB audio adapter and pass it through.\n- No issues other than audio. Works like a charm.\n\n"
    },
    {
      "title": "droserasprout poor man's setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i3-6100\n- Motherboard: ASRock H110M2 D3 (BIOS version 0603)\n- Host GPU: Intel HD 530\n- Guest GPU: Sapphire Radeon R7 360\n- RAM: Apacer 8Gb 75.C93DE.G040C, Kingston 4Gb 99U5401-011.A00LF\n\nConfiguration:\n\n- Kernel: linux-lts 4.9.67-1 (vanilla)\n- Host OS: Arch Linux\n- Guest OS: Windows 10 Pro 1709 (build 16299.98)\n- Using libvirt/QEMU: See my configs and IOMMU groups on Github\n- HDD partition is passed to the VM as a raw virtio device.\n- HD Audio is passed too. Works fine with both playing and recording, no latency issues or glitches. After VM is powered off host audio works fine too.\n- Guest's latency is slightly better when CPU cores are isolated for VM.\n- i2c-dev module added to bypass 'EDID signature' error when switching HDMI. Without it I had to switch video output before starting VM for some reason.\n- intremap=no_x2apic_optout kernel option added to bypass motherboard firmware falsely reporting x2APIC method is not supported. Seems to have a strong influence on the guest's latency.\n- Overall performance is pretty close to the native OS setup.\n\n"
    },
    {
      "title": "prauat: 2xIntel(R) Xeon(R) CPU E5-2609 v4, 2xGigabyte GeForce GTX 1060 6GB G1 Gaming, Intel S2600CWTR",
      "level": 3,
      "content": "Hardware:\n\n- CPU:2xIntel(R) Xeon(R) CPU E5-2609 v4\n- Motherboard: Intel S2600CWTR(Revision ???, BIOS/UEFI Version: SE5C610.86B.01.01.0022.062820171903)\n- GPU: 2xGigabyte GeForce GTX 1060 6GB G1 Gaming [GeForce GTX 1060 6GB] (rev a1)\n- RAM: Samsung M393A2G40EB1-CPB 2133 MHz 64GB (4x16GB)\n\nConfiguration:\n\n- Kernel: Linux 4.14.15-1-ARCH #1 SMP PREEMPT\n- Using libvirt/QEMU: https://github.com/prauat/passvm/blob/master/generic.xml\n- Most important:\n- When using nvidia driver hide virtualization to guest <kvm><hidden state='on'/></kvm>\n- Configuration works with Arch Linux guest os, still work in progress.\n\n"
    },
    {
      "title": "Dinkonin's virtual gaming/work setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel(R) Core(TM) i7-7700K CPU @ 4.60GHz\n- Motherboard: MSI Z270 GAMING PRO CARBON (MS-7A63) BIOS Version: 1.80\n- GPU: 1x Gigabyte GeForce GTX 1050 2GB (host), 1x MSI GeForce 1080 AERO 8GB(guest)\n- RAM: 32GB DDR4\n\nConfiguration:\n\n- Kernel: Kernel version linux 4.15.2-2-ARCH.\n- Using libvirt/QEMU (patched from AUR) with OVMF\n- Installed qemu-patched from AUR because of crackling/delayed sound with pulseaduio (still hear ocasional pops/clicks while gaming.\n- Patched video bios with https://github.com/Matoking/NVIDIA-vBIOS-VFIO-Patcher, because of error:\n\n```\nvfio-pci 0000:01:00.0: Invalid PCI ROM header signature: expecting 0xaa55, got 0xffff\n```\n\n- Single monitor setup, implemented full software KVM(for host and guest) described here: https://rokups.github.io/#!pages/full-software-kvm-switch.md\n\n"
    },
    {
      "title": "pauledd's unexeptional setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i7 6700K\n- Motherboard: Gigabyte GA-Z170N-WIFI Retail (Revision 1.0 , BIOS/UEFI Version: F20)\n- GPU: 8GB Palit GeForce GTX 1070 Dual Aktiv PCIe 3.0 x16 (Retail)\n- RAM: 16GB G.Skill RipJaws V DDR4-3200 DIMM CL16 Dual Kit\n\nConfiguration:\n\n- Kernel: 4.15.2-gentoo\n- Using libvirt/QEMU: libvirt-4.0.0, qemu-2.11.1, https://github.com/pauledd/GPU-Passthrough/blob/master/win10-2.xml , using vfio kernel module\n- Had to dump VBIOS in at the host while GPU was normally attached (and drivers loaded) (see https://stackoverflow.com/a/42441234), had to set CPU settings manually according to my cpu (host-passthrough, sockets 1, cores: 4, threads: 2 ) or some games will regularly crash, see my xml how to insert vbios, still have audio clicking/lag with PulseAudio but that's ok for me, no further patching etc… works out of the box without any issues.\n- 3DMark Results Time Spy Graphic Score: Native Windows 10: 5564 , GPU-Passthrough: 5541\n\n"
    },
    {
      "title": "hkk's Windows gaming machine (6700K, 1070, 16GB)",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Core i7-6700K 4.5GHz\n- Motherboard: AsRock Fatality Gaming K6 Z170 (rev. 1.05)\n- Host GPU: Intel GPU HD530 with 1GB shared memory\n- Guest GPU: Gigabyte GeForce GTX1070 G1 Gaming 8GB\n- RAM: 16GB G.Skill RipjawsV @ 3333 MHz CL14-15-15-31-2T [DDR4]\n\nConfiguration:\n\n- Host Kernel: Kernel version Linux 4.15.7-1-vfio (with ACS patch included).\n- Using libvirt QEMU/KVM with OVMF\n- Host OS: Arch Linux\n- Guest OS: Windows 10 Pro\n- 128GB Intel 600p SSD splited into 3 partitions: 512MB for EFI, 30GB for / in Btrfs and other gigs for Windows 10 installed straight on SSD.\n- Two more HDDs for Windows. 1TB and 650GB\n- Passed specific devices like X360 and some of single USB ports.\n- One NIC behind NAT on VM machine.\n- VM gets dedicated 8GB RAM via static hugepages.\n- CPU pinning increased performance considerably and machine gets 4/4 cores of my 4/8 CPU\n- Windows boots on second screen with simple script which shutting down display with xrandr.\n- Using Synergy to share mouse and keyboard between systems.\n- Quirks:\n- Synergy is not perfect and will not entirely work in some games.\n- No boot screen. Display is turning on only when Windows is up and ready to go.\n\n"
    },
    {
      "title": "sitilge's treachery",
      "level": 3,
      "content": "Full info: https://github.com/sitilge/virtualization\n\nHardware:\n\n- CPU: Intel Core i5 6600K\n- Motherboard: Asus Z170i\n- GPU: Gigabyte Radeon RX460 OC 2GB\n- Storage: Samsung 850 EVO 500GB\n- RAM: Corsair 16GB DDR4\n- Mouse, Keyboard: Logitech M90, Vortex Pok3r\n\nHost Configuration:\n\n- Kernel: linux-vfio\n- Packages: qemu-git, virtio-win, ovmf\n\nGuest Configuration:\n\n- OS: Windows 10 Pro\n- CPU: host\n- Motherboard: host\n- GPU: passthrough\n- Storage: 64GB\n- RAM: 8GB\n- Mouse, Keyboard: passthrough\n\nNotes:\n\n- You can easy simlink the config files using stow -t / boot mkinitcpio and then mkinitcpio -p linux-vfio.\n- -smp cores=4 - guest might utilize only one core otherwise.\n- -soundhw ac97 - I am passing mobo audio thus ac97. Download, unzip and install the Realtek AC97 drivers within a guest.\n- Use virtio drivers for both block devices and network. For example, the ping went down from 250 to 50.\n- Mouse and keyboard passthrough solved the terrible lag problem which was present in emulation mode.\n- Make sure virtualization is supported and enabled in your firmware (UEFI). The option was hidden in a submenu in my case.\n- As trivial as it sounds, check your cables.\n- Be patient - it took more than 10 minutes for the guest to recognize the GPU.\n\n"
    },
    {
      "title": "chestm007's hackery",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Ryzen 7 1800x\n- Motherboard: Asus ROG Crosshair VI (Revision 1, BIOS/UEFI Version: 3502)\n- GPU: Asus ROG RX480oc 8GB\n- RAM: 32gb Ripjaws 2400mhz\n\nConfiguration:\n\n- Kernel: 4.16.12-1-ARCH.\n- Using libvirt/QEMU: libvirtd (libvirt) 4.3.0, QEMU emulator version 2.12.0,\n\nNotes:\n\n- using ic6 audio - works fine for me.\n- have a working looking-glass setup, however cant get spice to pass through keyboard and mouse, currently using a mixture of synergy and a dedicated screen as a workaround\n\n"
    },
    {
      "title": "Eduxstad's Infidelity",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Ryzen 2600X @ 3.7 GHZ\n- Motherboard: ASUS PRIME B350-PLUS(BIOS/UEFI Version: 4011)\n- GPU1 (Guest): MSI 390 8GB @ Stock\n- GPU2 (Host): XFX 550 4GB @ Stock\n- RAM: 2 x 8GB (16GB) @ 3000 HZ\n- Guest OS: Windows 8.1 Embedded Pro\n\nConfiguration:\n\n- Kernel: 4.17.3-1-ARCH (vanilla).\n- Using libvirt/QEMU: libvirt/virt-manager (https://github.com/eduxstad/vfio-config).\n- Look in the repository for complete documentation of extra steps taken\n- Overview: VM managed using virt-manager, using looking glass for primary io and built in spice display server as backup. Passing vm audio back to PulseAudio. Using hugepages for RAM. SCSI Drivers installed for hardware drive support.\n\n"
    },
    {
      "title": "Pi's vr-vm",
      "level": 3,
      "content": "Hardware:\n\n- CPU: i7-8700k @ 4.8 GHz\n- Motherboard: MSI Gaming Pro Carbon (BIOS/UEFI Version: A.40/5.12)\n- GPU: Palit RTX 2080 Ti\n- RAM: 4x8GB G.Skill DDR4 @ 3000 MHz\n\nConfiguration:\n\n- Kernel: latest mainline (rc if available) custom built with ZFS, WireGuard CONFIG_PREEMPT_VOLUNTARY=y to work around QEMU bug with long guest boot times\n- Startup scripts/additional info: https://github.com/PiMaker/Win10-VFIO\n- Issues encountered: PUBG would not launch at all Solution: Enable the HyperV clock with <timer name='hypervclock' present='yes'/> and disable hpet with <timer name='hpet' present='no'/> VR would start to stutter badly after about 20-30 minutes of playtime (this one took me about 2 weeks to finally figure out :-) Solution: Enable invariant tsc passthrough with <feature policy='require' name='invtsc'/> (required even if using host-passthrough!) Enable MSI for the GPU (using tool from here) Enable vAPIC and synic in the HyperV configuration Manually move all IRQs to host cores using qemu_fifo.sh script from my GitHub repository above\n- Overview: SteamVR-capable gaming and workstation rig, passing through NVIDIA GPU and onboard USB-controller (leaving an additional ASMedia USB port to the host). 22 GB hugepages memory, 10 of 12 cores (with SMT) passed through. Audio working via Scream (https://github.com/duncanthrax/scream) - with IVSHMEM, surprisingly low latency and no stutters.\n\n- custom built with ZFS, WireGuard\n- CONFIG_PREEMPT_VOLUNTARY=y to work around QEMU bug with long guest boot times\n\n- PUBG would not launch at all Solution: Enable the HyperV clock with <timer name='hypervclock' present='yes'/> and disable hpet with <timer name='hpet' present='no'/>\n- VR would start to stutter badly after about 20-30 minutes of playtime (this one took me about 2 weeks to finally figure out :-) Solution: Enable invariant tsc passthrough with <feature policy='require' name='invtsc'/> (required even if using host-passthrough!) Enable MSI for the GPU (using tool from here) Enable vAPIC and synic in the HyperV configuration Manually move all IRQs to host cores using qemu_fifo.sh script from my GitHub repository above\n\n- Solution: Enable the HyperV clock with <timer name='hypervclock' present='yes'/> and disable hpet with <timer name='hpet' present='no'/>\n\n- Solution: Enable invariant tsc passthrough with <feature policy='require' name='invtsc'/> (required even if using host-passthrough!) Enable MSI for the GPU (using tool from here) Enable vAPIC and synic in the HyperV configuration Manually move all IRQs to host cores using qemu_fifo.sh script from my GitHub repository above\n\n- Enable invariant tsc passthrough with <feature policy='require' name='invtsc'/> (required even if using host-passthrough!)\n- Enable MSI for the GPU (using tool from here)\n- Enable vAPIC and synic in the HyperV configuration\n- Manually move all IRQs to host cores using qemu_fifo.sh script from my GitHub repository above\n\n"
    },
    {
      "title": "coghex's gaming box",
      "level": 3,
      "content": "Hardware:\n\n- CPU: i7-8086k @ 5.0 GHZ (8086k is just a binned 8700k)\n- Motherboard: GIGABYTE Z370 AORUS Gaming 7 rev1.0 (BIOS/UEFI Version: F15a)\n- GPU: GIGABYTE GV-N108TAORUSX WB-11GD AORUS GeForce GTX 1080 Ti Waterforce WB Xtreme Edition 11G @ ~2Ghz\n- RAM: 4 x 8GB (32GB) Corsair Dominator Platinum @ 3600 HZ (XMP)\n\nConfiguration:\n\n- Kernel: linux-zen-5.5.8.zen1-1\n- Modules: raid0 raid1 md_mod ext4 vfat ahci vfio_pci vfio vfio_iommu_type1 vfio_virqfd usbhid it87 (aur version is unmaintained and the support for the ITE8686E chip on this board is limited, replace it87 source with that which is found here for more comprehensive support)\n- Virsh: virsh-5.10.0\n- Qemu: qemu-system-x86_64-4.2.0 machine='pc-i440fx-4.2'\n- Performance Services: irqbalance-1.6.0, ananicy-git-2.1.0.r22, cpupower5.5-1\n- EDIT(2020): much has changed since this setup was posted years ago and a custom kernel is no longer needed on this hardware, everything works perfectly...\n- scripts, libvirt XML, and personal configs can be found here: https://github.com/coghex/hoest\n- host boot options: intel_iommu=on iommu=pt rd.driver.pre=vfio-pci acpi_enforce_resources=lax\n- systemd modprobe.d options: kvm ignore_msrs=1 (avoids critical bugs), kvm report_ignored_msrs=N (cleans up journal logs)\n- libvirt features: acpi, apic, kvm hidden state='on', vmport state='off'\n- guest hyper-v options: hv-relaxed, hv-vapic, hv-spinlocks (retries='8191'), hv-vpindex, hv-runtime, hv-synic, hv-stimer, hv-stimer-direct, hv-reset, hv-vendor_id (value='1234567890ab'), hv-frequencies, hv-reenlightenment, hv-tlbflush, hv-ipi, (hv-evmcs and hv-no-nonarch-coresharing seemingly do not work yet in virsh)\n- make sure to use the multifunction field for the GPU's hdmi audio controller and set them to the same slot, otherwise the audio interrupts will hang. Someone should probably add that to the guide...\n- im running the clock at 100Hz, the people running it at 1000 with the zen or ck kernel should know that the MuQSS scheduler works the same regardless of this speed and 1000 will just add more useless interrupts.\n- cpu pinning works best for single VM performance, default host-passthrough works best for multiple running VMs.\n- on windows, the MSI_util_v2 gets used every update to reset MSI interrupts on the GPU.\n\nHardware Specific:\n\n- Fully-Functional Passthrough Devices: this motherboard has many PCI slots, all of these devices have been working flawlessly with little setup for years now: Inatek USB Card: KT5001 [2] Creative Sound Card: 70SB155000001 [3] EDUP Wi-Fi Card: AC9636GS (must use virtio usb passthrough for bluetooth functionality) [4] Intel Optane SSD: SSDPED1D480GASX [5] Zotac GeForce GT 710: ZT-71304-20L (this one does not seem to be available on amazon anymore, a shame since its one of the few high performance PCIEx1 cards...) [6]\n- none of the proprietary gigabyte software works, in fact, it blue screens windows and installs itself as a startup program, forever locking you out.\n- if anyone else uses this exact motherboard, there are two internal USB IOMMU groups, even with the ACS patch. one will include the usb labeled \"USB 3.1\", and the other will include all the other USBs. this means if you want more than just a keyboard and mouse, you will need either a usb hub to plug into the 3.1 slot and passthrough, or a PCIE USB bus.\n- the two ethernet ports are in different IOMMU groups, making this a perfect motherboard for vfio.\n- the ACS patch is needed on this motherboard if you want to use two graphics cards at once in separate IOMMU groups. this sets the main GPU to PCIEx8 instead of x16.\n\n- Inatek USB Card: KT5001 [2]\n- Creative Sound Card: 70SB155000001 [3]\n- EDUP Wi-Fi Card: AC9636GS (must use virtio usb passthrough for bluetooth functionality) [4]\n- Intel Optane SSD: SSDPED1D480GASX [5]\n- Zotac GeForce GT 710: ZT-71304-20L (this one does not seem to be available on amazon anymore, a shame since its one of the few high performance PCIEx1 cards...) [6]\n\n"
    },
    {
      "title": "Roobre's VFIO setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz\n- Motherboard: Gigabyte Z390 M GAMING\n- GPU: EVGA GTX 1080Ti\n- RAM: 32GB DDR4 2400 (2x Ballistix)\n\nConfiguration:\n\n- Kernel: Latest -ARCH (5.9.1-arch1-1 at the time of writing)\n- Using libvirt/QEMU: libvirt 1:6.5.0-3, qemu 5.1.0-2. Config: https://gist.github.com/roobre/8f2d86a51a6b619a6622a64a58f9fc94[dead link 2025-01-22 ⓘ]\n- ZFS volumes passed as raw devices for hard drives with virtio-scsi.\n- VirtIO all the things! Download drivers from https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/\n\nIssues:\n\n- PulseAudio never worked good (too much crackling), so I ended up passing-through an USB 3.1 PCI controller and connecting an USB audio card to it. That card is then connected to one of my MoBo's inputs, and echoed using PulseAudio loopback module.\n\n- Synergy works really great. On some games (ones who take control of the mouse pointer, e.g. first-person), you need to lock the mouse cursor to the VM window to avoid issues (camera moving too fast).\n\n- Do not forget to add the needed snippet for the nvidia driver to run (PCI passthrough via OVMF#\"Error 43: Driver failed to load\" with mobile (Optimus/max-q) nvidia GPUs)\n\n"
    },
    {
      "title": "laenco's VFIO setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Ryzen 9 3950X @ 4.15Ghz all-cores via PBO\n- Motherboard: Asus ROG STRIX X470-F GAMING (BIOS/UEFI Version: 5406)\n- GPU1 (Guest): Palit GeForce GTX 1080 8GB @ Stock\n- GPU2 (Host): MSI RX 570 8GB @ Stock\n- RAM: 4 x 16GB (64GB) @ 3333 MHz\n\nConfiguration:\n\n- Guest OS: Windows 10 Pro\n- Kernel: 5.4.13-arch1-1-gc (-ck is also good). No ACS patch.\n- Using vanilla QEMU 4.2.0\n- AMD Ryzen currently (2020.01.20) got bugged with SMP threads option - VM stuck on start.\n- Got classic Nvidia error 43 - classically fixed. But also added some CPU flags which are set automatically with kvm=on found here https://github.com/qemu/qemu/blob/master/target/i386/cpu.c#L4008\n- As pure QEMU have no option to pin CPU cores and self threads - using python script \"cpu_affinity\" - credits to https://github.com/zegelin/qemu-affinity/ and also a copy in my repository. Requires debug-threads=on\n- Using dynamically allocated hugepages 2Mb\n- Hardly using VirtIO\n- Using hardware USB switch like Aten US224-AT and HDMI switch \"many-to-one\", which allow me to have one monitor, mouse, keyboard and some USB devices, and switch them by button between host and guest.\n- Repository with current major system config and script for VM could be found here https://github.com/laenco/vfio-config\n\n"
    },
    {
      "title": "zane's not working box",
      "level": 3,
      "content": "Hardware:\n\n- MacBook Pro 11,x (2014 Model)\n- CPU: Intel Core i7-4770HQ\n- Motherboard: Apple\n- GPU: Iris Pro 5200 for host, GTX 1660 eGPU over Thunderbolt 2 for guest\n- RAM: 16GB\n\nConfiguration:\n\n- Kernel: linux-vfio from aur 5.5.8\n- qemu: 4.2.0\n- libvirt: 5.10.0\n- ovmf: 1:r26976.bd85bf54c2\n- libvirt/QEMU: libvirt setup; qemu setup\n\nDescription:\n\n- The qemu script include lines for setting up device mapped file for raw disk access. 3D Performace is about 40% to 80% native depending on the application, with periodic lag spike/stutter.\n\nIssues:\n\n- Use apple_set_os.efi or spoof_osx_version with refind to avoid black screen on start. This prevents Apple firmware from shutting down host iGPU when booting Linux/Windows.\n- CPU pinning for guest is mandatory as it removes majority of stutters. After that isolate host CPU cores and pin emulator/IO threads as well. Pi's script for pinning IRQ handlers also helps. Hugepages for memory helps.\n- Kernel parameters: intel_iommu=on iommu=pt pcie_acs_override=downstream pci=realloc vfio-pci.ids=10de:2184,10de:1aeb,10de:1aec,10de:1aed,8086:0d01,8086:156d,8086:156c isolcpus=0-5 nohz_full=0-5 rcu_nocbs=0-5 default_hugepagesz=1G hugepagesz=1G hugepages=12 mitigations=off pcie_aspm=off module_blacklist=nvidia audit=0 loglevel=3 quiet. Everything starting with mitigations=off are optional. pci=realloc is mandatory or you will get NVRM: This PCI I/O region assigned to your NVIDIA device is invalid: NVRM: BAR1 is 0M @ 0x0 (PCI:0000:0a:00.0) error in dmesg and Error 43 for the Nvidia driver in guest.\n- Add vfio_pci vfio vfio_iommu_type1 vfio_virqfd to your mkinitcpio.conf as normal. Add options kvm ignore_msrs=1 and options kvm report_ignored_msrs=N to your /etc/modprobe.d/kvm.conf as well.\n- For me ACSO patch is mandatory, available from linux-vfio aur.\n- Enabling MSI for guest GPU seemingly helps. Using ioh3420 device and passthrough GPU on top of that DOES NOT seem to help, while making PulseAudio output cracks badly. Setting mixing-engine=off for PulseAudio also makes it cracks badly so consider USB soundcard if needed. (I personally use the sound out on my monitor from guest). While I am not sure what this option does, setting in.buffer-length on PulseAudio audiodev reduces cracks.\n\n"
    },
    {
      "title": "Muata's VFIO setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: i7 4790\n- Motherboard: MSI B85M-G43 BIOS/UEFI Version: V3.9 (03/30/2015)\n- GPU: NVIDIA GeForce GTX 1060 6GB (MSI Gaming+)\n- RAM: 16GB\n\nConfiguration:\n\n- Kernel: linux-zen 5.5.11-1\n- Using libvirt/QEMU: VFIO setup;\n- qemu: 4.2.0\n- libvirt: 5.10.0\n- No issues at moment of writing this.\n\n> I had some issues with the network, for example, I could not connect to Activision games servers (CoD: MW, Overwatch) but I have changed firewall settings from public to private and everything is good for now.\n\n> For the first time, I had windows on .raw image and disk was throttling a lot, I have set up raid0 on my 2 HDD's, then I created 3 partitions with LVM - 120GB for windows, 700GB for data(games), 700gb for Linux data and passthrough two of partition as Virtio-BLK. RAID&LVM\n\n> Audio passthrough is done through the usual PulseAudio solution, works nicely.\n\n> For some people who, maybe looking how to passthrough GPU - because it's not obvious when you doing it for the first time and it's not on the wiki though, so when you pass a correct group of vfio-pci.ids then you need to add in (easiest way) a Virtual Machine Manager - Add hardware - PCI Host Device - You graphic card (for me it was 0000:01:00:0 NVIDIA Corporation GP106 [GeForce GTX 1060 6GB]).\n\n"
    },
    {
      "title": "peterge's VFIO setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: AMD Ryzen 5 3700X\n- Motherboard: MSI x370 Gaming Pro Carbon\n- GPU: SAPPHIRE PULSE Radeon RX 5700 XT (Host), MSI RX 570 (VM)\n- RAM: 32GB\n\nConfiguration:\n\n- Kernel: 5.11.11-arch1-1\n- Using libvirt/QEMU: Xml File\n- No issues right now.\n\n> Mouse and keyboard passthrough with evdev.\n\n> Monitor connected to both GPUs to display native 144hz.\n\n> Needed this option in /etc/modprobe.d/kvm.conf, related to my Ryzen CPU: options kvm ignore_msrs\n\n> Had problems passing sound to host with a ICH6 device, sound was crackeling and a bit delayed. Then switched to scream-ivshmem and sound is working perfectly now. Its great in combination with looking-glass.\n\n> Tried to build a solution where i can use my main GPU (GTX 1080) on Host and VM, by rebinding drivers. Rebinding drivers worked on the GTX 1080, but it was not able to use it to offload games from my host gpu back then Reddit Post (Got it working with an R9 380 for the host, but needed to restart xorg every time). Then bought the RX 5700 XT, where GPU offloading worked like a charm, but due to the early stage of driver support driver rebinding is not supported Reddit Post. So i currently have 2 GPUs in my rig.\n\n"
    },
    {
      "title": "CaptainSolidus's VFIO Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel Xeon E3-1245 V2\n- Motherboard: Gigabyte Z77A-G45 (BIOS/UEFI Version: 2.12)\n- Host GPU: AMD ATI Radeon HD 7950/8950 / R9 280 (AMDGPU with SI support enabled)\n- Guest GPU: NVIDIA GeForce GTX 1060 6GB\n- RAM: 2x8GB DDR3 1600 (8 for the host, 8 for the guest)\n\nConfiguration:\n\n- Kernel: 5.7.4-1 (ACS-patched)\n- Using libvirt/QEMU: libvirt 6.4.0/QEMU 5.0.0 VFIO repository\n- Guest OS: Windows 10 Pro 2004\n- Motherboard puts all PCIe lanes in a single IOMMU group, and no way to edit in BIOS, thus the ACS patch. There seems to be no issues having with this.\n- CPU Pinning worked best, passing through CPUs 1,2,3,5,6,7 and leaving 0 & 4 for the host. Using \"host-model\" as CPU type and setting a topology helped with edge case crashes during benchmarking\n- The Intel integrated graphics worked fine as well, but I kept the R9 280 for anything Linux native or older. Both GPUs work with Looking Glass.\n- Switched to VirtIO drivers for SCSI and Networking, and ICH9 for audio.\n- Keyboard and mouse are passed through via the evdev method\n- Audio crackled using PulseAudio passthrough, so I switched to Scream over the bridged network, which works perfectly. The Scream client starts with the system, so I do not need to enable it on boot.\n- Looking Glass is also set up, and works well on the client. The Looking Glass client is set to boot with the VM, and the VM is set to automatically login (via netplwiz)\n- Setting up sleep prevention will help prevent the host machine sleeping while gaming in the VM\n\n"
    },
    {
      "title": "ash's gaming machine",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel i5-8600k\n- Motherboard: Aorus Z390 Ultra, rev. 1\n- GPU: passthrough: AsRock Radeon Vega 56. host: Intel UHD 630\n- RAM: 32GB G.SKILL Trident Z Neo, 16GB for Windows\n\nConfiguration:\n\n- Kernel: 5.12.5-zen1-3-zen-ash-patches (custom kernel) or my custom tkg kernel, made with this\n\n- Using libvirt/QEMU: libvirt through virt-manager, QEMU with custom patches, found here\n\n- i had a lot of issues getting my VM to boot. i first had to completely disable my amdgpu kernel driver, mainly in /etc/modprobe.d/blacklist.conf. i then had to add my GPU id from lscpi -nnk to /etc/modprobe.d/vfio.conf. i also had to force Xorg to use my Intel GPU in a file called /etc/X11/xorg.conf.d/10-intel.conf. after combining all that with the information in the main PCI pass-through page, i was able to get everything to boot.\n\n- all my configuration files are here\n\n- i use screamAUR for audio, and barrier for moving my mouse from one monitor to another, like you would on a single OS system.\n\n- i patched a couple upstream arch packages, mainly for VM detection evasion. those packages are QEMU, OVMF (edk2), and the linux-zen kernel. those patches are found at this repository. it also includes pre-built versions of the packages under the releases section. go check them out!\n\n"
    },
    {
      "title": "Redecorating's vfio on a MacBookPro",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Intel i7-9750H\n- Motherboard: MacBookPro16,1 (BIOS/UEFI Version: 1554.80.3.0.0 (iBridge: 18.16.14347.0.0,0))\n- Guest GPU: AMD ATI Radeon RX Pro 5300M + Intel gvt-t virtual gpu\n- Host GPU: Intel UHD Graphics 630\n- RAM: 16GB, 8GB for guest\n\nConfiguration:\n\n- Kernel: 5.10.12 (linux-mbp, which is for macs with the t2 chip).\n- Using libvirt/QEMU: Libvirt (qemu backend)\n- Enabled iGPU as described here.\n- Had to isolate dGPU with vfio-pci from boot and use vendor-reset. Needed to pass through my usb-c ports as they are in the same iommu group, but not thunderbolt (guest gpu driver does not load if they are passed through). Only could install guest gpu drivers included with apple's \"bootcamp support software\".\n- Libvirt xml and a more detailed explanation of quirks I had to work around are on this gist.\n- Although there is a gmux chip in this laptop, it's unknown how to make the internal display switch between the iGPU and dGPU without rebooting.\n\n"
    },
    {
      "title": "sashok724's VFIO setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Ryzen 3950X\n- Motherboard: ASUS X570 Hero WiFi\n- GPU (Host): RX 5700 XT\n- GPU (Guest): GTX 1080 Ti\n- RAM: 16x4 GB (64GB) @ 3600MHz CL16\n\nConfiguration:\n\n- Kernel: Stock\n- Using QEMU: 6.0.0\n- Everything mostly worked out of the box. I only needed to enable IOMMU in UEFI.\n- Repository with my configuration: https://github.com/new-sashok724/windows.sh/\n- I am using systemd unit to start VM\n- I have also passed through separate USB controller inside VM\n- KVM hidden state is not needed in my case, since NVidia allowed using their GPUs in VMs recently\n- Audio (HDA) also works fine without any stuttering out of the box\n\n"
    },
    {
      "title": "QGJ's VFIO setup (CPU: Ryzen 5 3600XT / GPU: AMD RX 570)",
      "level": 3,
      "content": "Hardware:\n\n- CPU: AMD Ryzen 5 3600XT\n- Motherboard: MSI X470 Gaming Plus Max; BIOS version: 7B79vHC\n- GPU (host): AMD Radeon R5 230\n- GPU (guest): MSI Radeon RX 570 Gaming X 4GB\n- RAM: 32 GB DDR4 in dual channel mode @ 3000 MHz\n\nConfiguration:\n\n- Distribution: Gentoo\n- Kernel: sys-kernel/gentoo-sources:5.15.5\n- libvirt: 7.7.0\n- QEMU: 6.0.0 (with ACPI table patch - needed for Red Dead Redemption 2)\n- Guest VMs: Windows 11 Pro, macOS Monterey\n- Link to my setup: https://github.com/q-g-j/gentoo-stuff[dead link 2023-05-06 ⓘ]\n\nNotes:\n\n- need the vendor-reset kernel module (strangely only when using macOS)\n- enabled avic in kernel module kvm_amd\n- fixed the L3 cache for my Ryzen\n- passing through the onboard USB 3 controller\n- using a custom libvirt hook script with the following features:- set the cpu governor- enable / disable some kernel optimizations- enable / disable hugepages- enable / disable WLAN bridging- start / stop scream audio with custom parameters- use one or more PCI devices alternately in the host and in the guest (virsh nodedev-detach / nodedev-reattach)\n- WLAN bridging: uses \"parprouted\" to \"join\" the wlan interface and the bridge to one subnet\n- patched QEMU and modified the xml to avoid crashes in the game \"Red Dead Redemption 2\"\n- macOS: use my own OpenCore image optimized for Ryzen CPUs (AMD vanilla patches) and with some additional kexts\n- installed a minimal Arch Linux as my 2nd distribution (dual-boot with Gentoo). This one runs headless and automatically boots two Windows 10 instances - one on each GPU. Works well for Multiplayer. Just needed to blacklist both radeon and amdgpu.\n\n"
    },
    {
      "title": "Zexceil's VFIO setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: AMD Ryzen 5 1600(Non-AF)\n- Motherboard: ASUS Crosshair VII Hero(Wi-Fi) (BIOS/UEFI Version: 4402, AGESA V2 PI 1.2.0.3 Patch A)\n- Host GPU: Nvidia Quadro NVS 510 2GB\n- Guest GPU: XFX RX 580 8GB GTS XXX\n- RAM: 4x8GB, 32GB~2666Mhz\n\nConfiguration:\n\n- Distribution: Endeavour OS\n- Kernel: Default packaged kernel(5.13.8-arch1-1 07/08/2021) patched with vendor-reset\n- libvirt: 7.6.0\n- QEMU: 6.0.0\n- Guest VMs: Windows 10 Pro\n- Guest VM XML: https://pastebin.com/50ZhZA1c\n- Using libvirt/QEMU:\n- Ensure that all CPUs except emulatorpin/iothread ones are using perfomance governer else choppiness experienced throughout, other CPUs use powersave to keep thermals good.\n- Had to run modules \"kvm\" & \"kvm_amd\" with options \"ignore msrs=1\" & \"nested=1\" else cpu passthrough does not work, neither does Hyper-V in Win10(Delivers decent non-buggy perf).\n- I do not use anything such as spice/looking-glass, guest gpu is connected to secondary monitor input.\n- To get decent perfomance I have overclocked my CPU to 4Ghz.\n- Resize-BAR is working.\n- Tested on kernel 5.14-rc4(compiled from source), working fine.\n- Ensure installation of VirtIO drivers for KB/Mouse(Obvious thing to do but I experienced horrible KB/Mouse perf without it and then came to realization)\n\n"
    },
    {
      "title": "UtkarshVerma's VFIO Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: AMD Ryzen 3550H\n- Motherboard: TUF Gaming FX505DT_FX505DT 1.0 (BIOS/UEFI Version: FX505DT.316)\n- GPU: NVIDIA GeForce GTX 1650\n- RAM: 8GB\n\nConfiguration:\n\n- Scripts: https://github.com/UtkarshVerma/qemu-vfio-win10\n- Kernel: Linux 5.14.1\n- Using libvirt/QEMU: QEMU (plain QEMU)\n- Running the VM is as simple as `sudo ./launch.sh`. It takes care of everything mentioned below in a distribution-agnostic way.\n- Hugepages\n- HyperV enlightenments\n- Dynamic VFIO passthrough for NVIDIA GPU, i.e. GPU is usable by host after guest exits.\n- Respects NVIDIA Runtime D3 power management\n- evdev passthrough using persistent-evdev.py\n- Looking Glass: SPICE input and clipboard sharing; DMA buffer support; Auto shared memory creation\n- virtio devices\n- PulseAudio audio device passthrough\n- CPU pinning with qemu-affinity\n- CPU governor configuration\n- Runs QEMU with jemalloc() memory allocator\n\n"
    },
    {
      "title": "Shimmy's VFIO Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: AMD Ryzen 5 1600 (original, non-AF) OC @ 3.6 GHz\n- Motherboard: MSI B350 Gaming Plus (BIOS/UEFI Version: 7A34vMHS)\n- Host GPU: XFX AMD Radeon RX 550 2 GB\n- Guest GPU: ASUS AMD RX 6600 XT DUAL OC 8GB GDDR6\n- RAM: 32 GB, 2x16GB @ 3200 MHz OC (in BIOS for the setup, RAM is native 3200) in dual channel\n- Storage: Crucial MX500 1 TB (dedicated entirely to the VM)\n\nConfiguration:\n\n- Host OS: Arch Linux 5.16.11\n- Guest OS: Windows 10 Home\n- Using libvirt/QEMU: QEMU 6.2.0, libvirt 8.0.0\n- XML config\n- Used to run Gigabyte GTX 1050 Ti as guest GPU\n- To achieve CPU passthrough I had to run `kvm ignore_msrs` options.\n- CPU cores pinning + systemd separation while the VM is running\n- Running the VM both directly to a 4K @ 144Hz dispaly and via Steam Link to TV\n- Looking Glass setup but rarely used\n- Running a bridged network to allow LAN access from TV\n- Managing by virt-manager or Cockpit to remotely start the VM\n- I have a separate \"no evdev\" setup in case I want to run the VM without any evdev devices\n- Needed `softdep amdgpu pre: vfio-pci` modprobe in my config for the amdgpu driver to not pickup guest GPU first. For some reason MODULES orderd in mkinitcpio didn't cut it.\n\n"
    },
    {
      "title": "yv-fr VFIO setup (CPU: Ryzen 3900 / GPU: 1080 & 3090)",
      "level": 3,
      "content": "Hardware:\n\n- CPU: AMD Ryzen 9 3900X 12-Core @ 24x 3.8GHz\n- Motherboard: ASRock x570 Taichi / Bios version=P4.40\n- Host GPU: NVIDIA GeForce GTX 1080 WATERCOOLED\n- Guest GPU: NVIDIA GeForce GTX 3090 WATERCOOLED\n- RAM: GSKILL GTRZ 16GB 4200 @3333\n- Storage: Dedicated SSD for guest.\n\nConfiguration:\n\n- Distribution: Archcraft\n- Kernel: x86_64 Linux 5.16.11-arch1-1\n- QEMU:(ACPI table patch version from this REDDIT before running anything. If not windows hold the pre patched ACPI info - needed for Red Dead Redemption 2)\n- Guest VMs: Windows 11 Pro\n- Link to my setup: XML\n- passthrough GPU is not usable by host after guest exits.\n- On this X570 All USB port are not on the same IOMMU group.\n\nNotes:\n\n- fixed the L3 cache by using vcpu used in pastebin link.\n- using udev keyboard+mouse passthrough\n- sound from the host without tear\n- here' s links that help me verry well uppon the wiki to construct this virtualisation. Gratefull to them\n\nhttps://www.tauceti.blog/posts/linux-amd-x570-nvidia-gpu-pci-passthrough-1-the-hardware/ https://www.heiko-sieger.info/windows-10-vfio-passthrough-configuration/\n\n"
    },
    {
      "title": "Drakensons VFIO Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Ryzen 5700G\n- Motherboard: MAG B550 TOMAHAWK\n- GPU: Nvidia GTX1070\n- Host GPU: iGPU of the CPU - Tipp: When choosing a mainboard, look for one with enough onboard video outputs!\n- RAM: 32GB Crucial Ballistix DDR4-3200 (16G goes to the VM)\n- Storage: 1x 512G Samsung 970 Evo Plus (NVMe), 1x 1TB WD blue SSD (SATA), 1x 2TB Samsung 970 Evo Plus (NVMe) - each one contains next to other data from my host a .raw-image file, maped to the VM, using BTRFS on the host, these files rest in a separate subvol with disabled COW.\n\nConfiguration:\n\n- Kernel: Vanilla Arch Kernel, no patches\n- libvirt/QEMU: Using libvirt\n- Guest: Windows 10 Professional (for the possiblity to log into the guest using RDP)\n- config files: Github\n- Optimizations:\n- CPU Pinning used, giving 6 Cores (12 threads) to the VM, using both threats of core 7 for the iothread, leaving core 8 and its thread for the host system for Youtube etc.\n- Using Looking Glass to access the machine, my old build had only 3 Cores for the VM, there i've encountered massive frame drops, on this system it runs absolutly smoothly at 1920x1080@60\n- Using Scream to redirect audio to the host, same as with looking glass applies here, with the current system no problems at all.\n- I've had some problems with the vfio driver, where the nvidia card initialized the efi framebuffer, which lead to some problems like nonbooting vms oder no image outboot during host boot. These problems could be solved using the video=efifb:off kernel parameter.\n- I am using dynamic hugepages for the slight placebo-like feeling that the VM runs smoother this way, to initialize these I'm using the qemu libvirt hook as seen in my config files.\n- Keyboard and Mouse is passed through using evdev - while using razer peripherals this has the plus, that colors and macro keys can be configured under linux, eliminating the need to install the synapse driver onto the guest.\n\n"
    },
    {
      "title": "JudgeHolden's Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: Ryzen 5900x\n- Motherboard: x570 Aorus Master\n- GPU: Nvidia RTX 3070, Nvidia RTX 3080 Ti\n- RAM: 32 GB (16x2), DDR4-3200 CL 14-14-14-34\n\nConfiguration:\n\n- Kernel: Vanilla Arch ACS-Patch\n- Using libvirt/QEMU\n- The only pronounced problem I've encountered is having performance issues after a lot of uptime the virtual machine(s) seem to start being randomly sluggish. I remedied this by implementing hugepagesz via kernel command line: `BOOT_IMAGE=/vmlinuz-linux root=UUID=4c86c780-3d89-4763-8f94-74f71dd009f1 rw loglevel=3 quiet kvm.ignore_msrs=1 video=efifb:off pcie_aspm=off pcie_acs_override=downstream,multifunction mitigations=off default_hugepagesz=1G hugepagesz=1G hugepages=16`\n- I do not pin or isolate any cores. I run an VM instance of win10 enterprise utilizing each GPU. I use my motherboard's soundcard for my 3080 Ti VM, I use my 3070's audio card (monitor aux output) for the other VM. I have a bridge set up (via nmtui) so all drives can be shared on the network (as well as host the occasional gameserver) from the guests and host. I use USB controller passthrough for both VMs. The 3080 Ti is plugged into a 4k 55\" TV that is sitting 3-4 ft in front of a loveseat (xbox controller, wireless kbm/touchpad, wired kbm, and usb switch are in this vicinity), while the 3070 is plugged into a single 240hz monitor at a desk with a gaming mouse and keyboard. The only device that is virtual/virtio device on either VM is the virtio NICs (if you don't count the CPU), and one block device HDD on the 3080 Ti VM.\n\n3080 Ti XML: http://ix.io/4jyV[dead link 2024-01-13 ⓘ] 3070 XML: http://ix.io/4jyW[dead link 2024-01-13 ⓘ]\n\nI used to have 28 hugepagesz allotted for both VMs, but have since been utilizing the host desktop a bit more so I needed to free up the RAM. So far there's been no performance problems on the 3070 VM since only giving hugepagesz to the 3080 Ti VM\n\n"
    },
    {
      "title": "Nedia's Setup",
      "level": 3,
      "content": "Hardware:\n\n- CPU: i5 13600K\n- Motherboard: MSI MPG Z790I EDGE WIFI\n- GPU: MSI Radeon RX 6750 XT\n- RAM: 32GB 5200MHz DDR5\n\nConfiguration:\n\n- Kernel: Vanilla\n- Using libvirt/QEMU: libvirt\n- XML: https://git.sr.ht/~nedia/vm/tree/main/item/win11.xml\n- Guest: Windows 11 for gaming.\n- Resizable BAR disabled in BIOS.\n- CPU core 0 not pinned, left for host, and cores 1-5 (threads 2-11) pinned so my VM will use all of my CPU's performance cores. Initially had pinned threads 2-13 which caused issues (stutters).\n- Dedicated bluetooth dongle for connecting bluetooth devices (headphones, controller).\n- 512GB SCSI disk for games, as well as 2 NVMe SSD's for games (PCI passthrough).\n\n"
    },
    {
      "title": "Aym vfio setup",
      "level": 3,
      "content": "Using on X570 setup for operating Host (archlinux) and two additional VM with their own GPUs\n\nHardware:\n\n- CPU: Ryzen 5950x\n- Motherboard: Gigabyte Aorus X570 Master 1.2 newest bios\n- GPU: Host: Nvidia RTX 3060Ti Guest1: Nvidia RTX 3070 Guest2: Nvidia RTX 3070\n- RAM: 4x16Gb Gskill B-Die 3200 cl14\n- USB: Additional USB Pciex1 by Fresco Logic FL1100\n- Monitors: 3x IPS with 144hz , 240 hz , 280 hz\n\n- Host: Nvidia RTX 3060Ti\n- Guest1: Nvidia RTX 3070\n- Guest2: Nvidia RTX 3070\n\nConfiguration:\n\n- Kernel: Archlinux Kernel 6.4 (with kernel >6.0 there is bug so vfio is done later when loading modules post)\n- Using libvirt/QEMU KVM 8.1:\n- In same time using Host and 2 VMs (Windows or archlinux)\n- scripts, libvirt XML, and personal configs can be found here: config\n- USB are passthough by own group so 2 VM had their own USB conntrolers (one from MB and one from Fresco)\n- GPU are connected by risers with Pcie4.0 standard\n- 2xNVME are passthrough by their own group to VM's and one NVME for host\n- Used Isolated NIC for internal talk to VMs\n- Used Barrier to comunicate via TCP for taking mouse and keyboard on VM's\n- CPU pinning was done VM1:cpuset=\"8-11,24-27\">8 cores VM2:cpuset=\"12-15,28-31\">8 cores\n- DKMS vendor-reset-dkms-git get rid of erros when restarting VMs\n- Audio passthourgh by Pipewire-pulse\n- Added CPU affinity by this this tutorial's\n- NIC has been pass by MACTAP\n- Latency is super stable, spikes are only generated by Nvidia Kernel Driver occasionaly\n- MSI interrupt done via MSI_util_v2\n- Scalling gouvernor is triggered by Hooks as MASK affinity Hooks/qemu.conf\n- Host GPU is in PCiex16 slot3 marked to boot from Gigabyte bios. No chipset bandwitch affected or noiced.\n- Hugepages are divided 2x16Gb ram for each VM\n\n"
    },
    {
      "title": "Alydev vfio setup",
      "level": 3,
      "content": "Hardware:\n\n- Laptop: Acer Nitro 5 AN515-57\n- CPU: i5-11400H @ 2.70GHz\n- GPU: GeForce RTX 3050 Mobile\n- RAM: 24gb generic SODIMM DDR4\n\nConfiguration:\n\n- Summary: OVMF on NVIDIA laptop with Arch host, Windows 10 guest, pcie passthrough, Looking Glass for laptop monitor, synchronized screen idle blanking, bluetooth device passthrough and hotplugging with evdev, GRUB boot entries to switch between Windows having the GPU and Arch retaining control of it\n\nDetails and configurations can be found on the user's GitHub repository.\n\n- Kernel: 6.7.4-arch1-1\n- Using libvirt 10.0.0, QEMU 8.2.0\n- Using persistent-evdev for hotplugging and bluetooth peripheral passthrough: aiberia/persistent-evdev[dead link 2025-03-15 ⓘ]\n- Looking Glass on Windows for laptop monitor\n- DPMS trigger over SSH to synchronize screen blanking\n\n"
    },
    {
      "title": "Adding your own setup",
      "level": 2,
      "content": "Add a new section with your nickname, CPU, motherboard and GPU models, then copy and paste this template to your section:\n\n```\nHardware:\n\n* '''CPU''': \n* '''Motherboard''': \n* '''GPU''': \n* '''RAM''': \n\nConfiguration:\n\n* '''Kernel''': Kernel version (vanilla/CK/Zen/ACS-patched or not).\n* Using '''libvirt/QEMU''':\n* Issues you have encountered, special steps taken to make something work a bit better, etc.\n* Describe your setup loosely here, so that when other wiki users are looking for something, they can easily skim through available setups.\n```\n\nReplace proper sections with your own data. Make sure to provide the exact motherboard model, revision (if possible - should be on both the motherboard itself and the box it came in) and BIOS/UEFI version you are using. Describe your exact software setup and add a link to your configuration files. (GitHub, GitLab, BitBucket, etc can host a public repository which you may update once in a while, but uploading them to pastebins is fine, too. Do not post the entire config file contents here.)\n\n"
    }
  ]
}