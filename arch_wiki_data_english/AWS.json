{
  "title": "AWS",
  "url": "https://wiki.archlinux.org/title/AWS",
  "sections": [
    {
      "title": "AMIs",
      "level": 3,
      "content": "Arch Linux AMIs are listed here: http://arch-ami-list.drzee.net/\n\nAMIs are build twice a month (the 1st and the 15th - 2:00am UTC) and are available for all regions that to do not explicitly require 'Opt-in' - see Region List. If an AMI is needed in a region where its currently not available, an AMI can be copied to that region.\n\nThe AMIs are EBS HVM AMIs and are available with two different kernels:\n\n- std - using the Standard Arch Linux Kernel from the default Arch repositories configured with the necessary modules for EC2 usage. The scheduler and I/O is not optimized for Cloud. A complete list of packages in the AMI: [1].\n- ec2 - using an EC2 optimized kernel of the Standard Arch Linux Kernel created by UplinkLabs and hosted in a dedicated repository - click here for more details. List of packages in the AMI: [2].\n\nBoth kernels have been tested on many different EC2 instance types (t2, t3, t3a, m/r/c5, m/r/c6 and advanced hardware with GPUs) and are booting fine.\n\nNote: **ec2** \n\nAMIs with LTS kernels are not built.\n\n"
    },
    {
      "title": "REST API to List AMIs",
      "level": 3,
      "content": "An REST API is available to get a JSON of available AMIs:\n\n- Get all AMIs: https://arch-ami-api.drzee.net/\n- Get list of latest AMI in each region: https://arch-ami-api.drzee.net/latest (this produces the same list as http://arch-ami-list.drzee.net/ but in JSON)\n- Get all AMIs in region: https://arch-ami-api.drzee.net/region - replace region with the desired region: eu-north-1, eu-west-1, us-east-1 etc.\n- Get all AMIs in region for CPU architecture: https://arch-ami-api.drzee.net/region/arch - replace arch with x86_64\n- Get all AMIs in region for CPU architecture and kernel-type: https://arch-ami-api.drzee.net/region/arch/type - replace type with std or ec2\n- Get Latest AMI in region for in region for CPU architecture and kernel-type: https://arch-ami-api.drzee.net/region/arch/type/latest - replace region, arch and type\n\n"
    },
    {
      "title": "First Run",
      "level": 3,
      "content": "After booting the AMI it is recommended/required to execute the following steps to initialize pacman and select fast local repositories:\n\n```\n# pacman-key --init\n# pacman-key --populate\n# reflector --country \"ISO 3166-1 Alpha-2 Country Code\" --protocol https,http --score 20 --sort rate --save /etc/pacman.d/mirrorlist\n# pacman -Syu\n```\n\nThe Reflector package is preinstalled in the AMIs.\n\nIt is recommended to set a proper configuration for reflector in /etc/xdg/reflector/reflector.conf and enable the timer services to regularly refresh the mirror list. For details see the Reflector package documentation.\n\nFor convenience, a script is included: /etc/pacman.d/pacman_init.sh.\n\nExecuting the script with sudo will automatically run the above pacman-key commands and setup Reflector by writing /etc/xdg/reflector/reflector.conf. Finally it will run Reflector to generate a mirrorlist.\n\nCountry selection for Reflector is done based on the AWS region where the instance is running. The following shows mapping between region and country codes (only regions where the AMIs are distributed to are supported):\n\n```\n# region_to_country['eu-west-1']='IE,UK,DE'\n# region_to_country['eu-west-2']='UK,IE,DE'\n# region_to_country['eu-west-3']='FR,DE,UK'\n# region_to_country['eu-central-1']='DE,FR,UK'\n# region_to_country['eu-north-1']='SE,FI,NO,DE'\n# region_to_country['us-east-1']='US,CA'\n# region_to_country['us-east-2']='US,CA'\n# region_to_country['us-west-1']='US,CA'\n# region_to_country['us-west-2']='US,CA'\n# region_to_country['ap-south-1']='IN,SG,US'\n# region_to_country['ap-northeast-1']='JP,KR,TW,US'\n# region_to_country['ap-northeast-2']='KR,JP,TW,US'\n# region_to_country['ap-northeast-3']='JP,KR,TW,US'\n# region_to_country['ap-southeast-1']='SG,ID,TH,US'\n# region_to_country['ap-southeast-2']='AU,NZ,US'\n# region_to_country['ca-central-1']='CA,US'\n# region_to_country['sa-east-1']='BR,CL,US'\n```\n\nFor EMEA Regions, \"DE\" (Germany), and for US/APAC/South America Regions, \"US\" (United States), is always included as a last resort should in country or \"neighbor\" country repositories be unavailable.\n\nAlternative provide your own mirrorlist and do not use the Reflector package.\n\n"
    },
    {
      "title": "Build process",
      "level": 3,
      "content": "The entire build process runs on AWS and is fully automated.\n\nOverall the automated build procedure is managed by a AWS Step Function that is executed at regular intervals using a Amazon EventBridge timed event.\n\nThe step function will initiate the build process and uses a combination of native calls and AWS Lambda functions for more complex elements.\n\nA new set of AMIs is build, by booting an EC2 instance with the previous AMI and using it as the work or build machine. The build machine is bootstrapped with a special build script that essentially uses pacstrap and some additional steps to build the image, the basics are outlined in section (2) below.\n\nFollowing the build of the AMI the new AMI is test booted on an EC2 instance to verify that it starts up correctly. If successful the AMI is distributed to the regions and registered in a DynamoDB database. The database can be queried using the API REST endpoint. Old AMIs are deleted from the regions and the DynamoDB database.\n\n"
    },
    {
      "title": "Credits",
      "level": 3,
      "content": "Thanks to Steven from UplinkLabs for helping to understand the build process and test the initial quality of the images. Also thanks to Mathcom for an excellent shells script to help me get started (unfortunately the link to that has been removed), which accelerate putting the basic build process together.\n\nYou may send comments and suggestions (without any promise that they will be looked at) to: arch-ami 'at' drzee.net\n\n"
    },
    {
      "title": "Wishlist",
      "level": 3,
      "content": "- Create official EC2/Cloud optimized kernels in the Standard Arch Linux repositories.\n- Add the AWS CLI v2 to the Standard Arch Linux repositories (v1 is available, but may be discontinued in the future) Unfortunately AWS CLI v2 was removed from the Extra Repo due to issues with Python 3.12 - images are again build with aws-cli v1\n\n- Unfortunately AWS CLI v2 was removed from the Extra Repo due to issues with Python 3.12 - images are again build with aws-cli v1\n\n"
    },
    {
      "title": "Building Arch AMIs",
      "level": 2,
      "content": "You can also build your own Arch Linux AMI. See [3] for details.\n\n"
    }
  ]
}