{
  "title": "APC UPS",
  "url": "https://wiki.archlinux.org/title/APC_UPS",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Related articles\n\n- Network UPS Tools\n\nThis document describes how to install the APC UPS daemon. The APC UPS can communicate with the Linux system through either a RS-232 or USB serial connection. In the event of a prolonged power outage, should the APC UPS lose most of its battery capacity, it can tell the Linux box to perform a safe shutdown.\n\n"
    },
    {
      "title": "Install the package",
      "level": 2,
      "content": "Install the apcupsd package.\n\n"
    },
    {
      "title": "Configure APC UPS",
      "level": 2,
      "content": "The main configuration file for the APC UPS daemon can be found in /etc/apcupsd/apcupsd.conf. The default configuration is for devices connected over a USB cable.\n\n"
    },
    {
      "title": "Test",
      "level": 2,
      "content": "First, enable and start apcupsd.service.\n\nNext, wait about a minute and confirm the daemon is running and properly monitoring the battery:\n\n```\n# apcaccess status\n```\n\n```\nAPC      : 001,033,0819\nDATE     : Sat Mar 05 SOMETIME 2005\nHOSTNAME : somehostname\nRELEASE  : 3.10.16\nVERSION  : 3.10.16 (04 November 2004) unknown\nUPSNAME  : somehostname\nCABLE    : USB Cable\nMODEL    : Back-UPS ES 725\nUPSMODE  : Stand Alone\nSTARTTIME: Sat Mar SOMETIME 2005\nSTATUS   : ONLINE\nLINEV    : 119.0 Volts\nLOADPCT  :  23.0 Percent Load Capacity\nBCHARGE  : 100.0 Percent\nTIMELEFT :  30.5 Minutes\nMBATTCHG : 5 Percent\nMINTIMEL : 3 Minutes\nMAXTIME  : 0 Seconds\nLOTRANS  : 088.0 Volts\nHITRANS  : 138.0 Volts\nALARMDEL : Always\nBATTV    : 13.5 Volts\nNUMXFERS : 0\nTONBATT  : 0 seconds\nCUMONBATT: 0 seconds\nXOFFBATT : N/A\nSTATFLAG : 0x02000008 Status Flag\nMANDATE  : 2002-12-02\nSERIALNO : QB0249360043\nBATTDATE : 2000-00-00\nNOMBATTV :  12.0\nFIRMWARE : 02.n2.D USB FW:n2\nAPCMODEL : Back-UPS ES 725\nEND APC  : Sat SOMETIME 2005\n```\n\nTo fully test your setup:\n\n1. Change TIMEOUT from 0 to 1 in the /etc/apcupsd/apcupsd.conf file.\n1. Remove wall power from the UPS.\n1. Observe that your Linux box powers down, in short order.\n1. Plug the UPS back into the wall.\n1. Power on your Linux box.\n1. Change TIMEOUT from 1 back to 0 in the /etc/apcupsd/apcupsd.conf file.\n\nWhen everything is ok, all that is left to do is enable the apcupsd service.\n\n"
    },
    {
      "title": "Hibernating instead of shutting down",
      "level": 2,
      "content": "You can make your system hibernate instead of shutting down. First, make sure the system hibernates cleanly. To set up hibernation, see Power management/Suspend and hibernate.\n\n"
    },
    {
      "title": "Create the hibernate script",
      "level": 3,
      "content": "Create this in /usr/local/bin/hibernate as root:\n\n```\n#!/bin/bash\n# Hibernate the system - designed to be called via symlink from /etc/apcupsd\n# directory in case of apcupsd initiating a shutdown/reboot.  Can also be used\n# interactively or from any script to cause a hibernate.\n\n# Do the hibernate\n/usr/bin/systemctl hibernate\n\n# At this point system should be hibernated - when it comes back, we resume this script here\n\n# On resume, tell controlling script (/etc/apcupsd/apccontrol) NOT to continue with default action (i.e. shutdown).\nexit 99\n```\n\nMake it executable.\n\n"
    },
    {
      "title": "Link the hibernate script for apcupsd to use it",
      "level": 3,
      "content": "Create a symbolic link from the /etc/apcupsd directory to the script. The result is the apcupd's apccontrol script, in this directory, will call the hibernate script instead of doing the default shutdown action for these operations.\n\n```\n# ln -s /usr/local/bin/hibernate /etc/apcupsd/doshutdown\n```\n\nIf you are running apcupsd as a client to another machine running apcupsd as a server and want your machine to hibernate if the server is shutdown or if communication to the server is lost then you may also wish to add:\n\n```\n# ln -s /usr/local/bin/hibernate /etc/apcupsd/remotedown\n```\n\n"
    },
    {
      "title": "Make apcupsd kill UPS power once the hibernate is done",
      "level": 3,
      "content": "Once the PC has hibernated successfully, it is common practice to switch off the UPS in order to conserve battery charge and prevent full battery drain. This can be achieved through a power suspend event in systemd.\n\nCreate /usr/lib/systemd/system-sleep/ups-kill and put the following contents in it:\n\n```\n#!/bin/bash\n\ncase $2 in\n\n  # In the event the computer is hibernating.\n  hibernate)\n    case $1 in\n\n       # Going into a hibernate state.\n       pre)\n\n         # See if this is a powerfail situation.\n         if [ -f /etc/apcupsd/powerfail ]; then\n           echo\n           echo \"ACPUPSD will now power off the UPS\"\n           echo\n           /etc/apcupsd/apccontrol killpower\n           echo\n           echo \"Please ensure that the UPS has powered off before rebooting\"\n           echo \"Otherwise, the UPS may cut the power during the reboot!!!\"\n           echo\n         fi\n       ;;\n\n       # Coming out of a hibernate state.\n       post)\n\n         # If there are remnants from a powerfail situation, remove them.\n         if [ -f /etc/apcupsd/powerfail ]; then\n           rm /etc/apcupsd/powerfail\n         fi\n\n         # This may also exist, need to remove it.\n         if [ -f /etc/nologin ]; then\n           rm /etc/nologin\n         fi\n\n\t # Restart the daemon; otherwise it may be unresponsive in a\n         # second powerfailure situation.\n\t systemctl try-restart apcupsd\n       ;;\n    esac\n  ;;\nesac\n```\n\nMake the script executable.\n\nNow you can test your setup.\n\n"
    },
    {
      "title": "The desktop environment will also sense the UPS if connected by USB cable",
      "level": 3,
      "content": "For example, the default KDE setting is to put the computer in sleep if it has been on UPS battery for more than 10 minutes and the mouse has not moved. On many computers this causes a crash. This can be changed from KDE System Settings > Power Management > On battery.\n\n"
    },
    {
      "title": "hid-generic : control queue full",
      "level": 3,
      "content": "If you are using a systemd-based initramfs you might run into the \"control queue full\" log message happening many times every second. You will want to add hid-generic to you modules and regenerate your initramfs.\n\n"
    },
    {
      "title": "See also",
      "level": 2,
      "content": "- Apcupsd home page\n- Forcing hibernate\n- apcupsd manual\n- Manage your APC battery backup system\n\n"
    }
  ]
}