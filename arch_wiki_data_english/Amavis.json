{
  "title": "Amavis",
  "url": "https://wiki.archlinux.org/title/Amavis",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Related articles\n\n- ClamAV\n- Postfix\n- Dovecot\n\nFrom Amavis's site:\n\n"
    },
    {
      "title": "Installation and setup",
      "level": 2,
      "content": "In this setup it is assumed that you are using ClamAV as anti-virus scanner.\n\n- Install amavisd-new. You would be wise to also install optdepends such as 7zip and unrar so your filters can actually see inside compressed files.\n- Install clamav.\n\n"
    },
    {
      "title": "Basic configuration",
      "level": 3,
      "content": "If your hostname is not a FQDN, you must set $myhostname and $mydomain accordingly in /etc/amavisd/amavisd.conf.\n\nYou can enable ClamAV support by commenting out the following lines (do not forget to put the same clamd.sock as in /etc/clamav/clamd.conf):\n\n```\n/etc/amavisd/amavisd.conf\n```\n\n```\n# ### http://www.clamav.net/\n['ClamAV-clamd',\n   \\&ask_daemon, [\"CONTSCAN {}\\n\", \"/var/lib/clamav/clamd.sock\"],\n   qr/\\bOK$/m, qr/\\bFOUND$/m,\n   qr/^.*?: (?!Infected Archive)(.*) FOUND$/m ],\n# # NOTE: run clamd under the same user as amavisd - or run it under its own\n# #   uid such as clamav, add user clamav to the amavis group, and then add\n# # NOTE: match socket name (LocalSocket) in clamav.conf to the socket name in\n# #   this entry; when running chrooted one may prefer a socket under $MYHOME.\n```\n\nAdd a comment to this line to enable anti-virus scan:\n\n```\n# @bypass_virus_check_maps = (1);  # controls running of anti-virus code\n```\n\nAfter that, add clamav user to amavis group to avoid permission problems:\n\n```\n# usermod -a -G amavis clamav\n```\n\nFinally restart the services:\n\n- restart clamav-daemon.service.\n- start amavisd.service and possibly enable it.\n\nCheck for errors with these commands:\n\n```\n# systemctl status amavisd\n# journalctl -u amavisd\n```\n\n"
    },
    {
      "title": "Testing",
      "level": 3,
      "content": "To test the new configuration just telnet to the amavisd default listening port:\n\n```\n$ telnet 127.0.0.1 10024\n```\n\nYou should see something like:\n\n```\nTrying 127.0.0.1...\nConnected to 127.0.0.1.\nEscape character is '^]'\n220 [127.0.0.1] ESMTP amavisd-new service ready\n```\n\nType ehlo 127.0.0.1:\n\n```\nEHLO localhost\n250-[127.0.0.1]\n250-VRFY\n250-PIPELINING\n250-SIZE\n250-ENHANCEDSTATUSCODES\n250-8BITMIME\n250-DSN\n250 XFORWARD NAME ADDR PORT PROTO HELO IDENT SOURCE\n```\n\nNow just type quit to exit.\n\n"
    },
    {
      "title": "Quick start",
      "level": 3,
      "content": "To configure amavis for Postfix add the following to /etc/postfix/master.cf:\n\n```\n#\n# anti spam & anti virus section\n#\namavisfeed      unix  -    -       n       -       2       smtp\n -o smtp_data_done_timeout=1200\n -o smtp_send_xforward_command=yes\n -o disable_dns_lookups=yes\n -o max_use=20\n127.0.0.1:10025 inet n  -       y       -       -       smtpd\n -o content_filter=\n -o smtpd_delay_reject=no\n -o smtpd_client_restrictions=permit_mynetworks,reject\n -o smtpd_helo_restrictions=\n -o smtpd_sender_restrictions=\n -o smtpd_recipient_restrictions=permit_mynetworks,reject\n -o smtpd_data_restrictions=reject_unauth_pipelining\n -o smtpd_end_of_data_restrictions=\n -o smtpd_restriction_classes=\n -o mynetworks=127.0.0.0/8\n -o smtpd_error_sleep_time=0\n -o smtpd_soft_error_limit=1001 \n -o smtpd_hard_error_limit=1000\n -o smtpd_client_connection_count_limit=0\n -o smtpd_client_connection_rate_limit=0\n -o receive_override_options=no_header_body_checks,no_unknown_recipient_checks,no_milters\n -o local_header_rewrite_clients=\n```\n\nIn this configuration we assume that postfix and Amavis are running on the same machine (i.e. 127.0.0.1). If that is not the case edit /etc/amavisd/amavisd.conf and the prevous Postfix entry accordingly.\n\nPostfix will listen to port 10025 so that Amavis can send back checked emails to that port.\n\nYou also have to add another other configuration in your smtp or submission sections:\n\n```\n-o content_filter=amavisfeed:[127.0.0.1]:10024\n```\n\nUsing this options implies that Postfix will send emails to Amavis on port 10024, so that these can be checked. If mail passes the control then these are sent to port 10025, as explained before.\n\nWe can now restart postfix.service and amavisd.service.\n\nTo check that Postfix is listening on port 10025 do the same operations as the port 10024 case.\n\n"
    },
    {
      "title": "SpamAssassin support",
      "level": 2,
      "content": "Note: **This article or section needs expansion.** This article or section needs expansion.\n\nThis article or section needs expansion.\n\nInstall spamassassin\n\nSpamassassin is integrated in Amavis so you do not have to start spamassassin.service. To enable support for Spamassassin comment the following line in /etc/amavis/amavis.conf like this:\n\n```\n# @bypass_spam_checks_maps = (1);  # controls running of anti-spam code\n```\n\nEdit the SpamAssassin configuration based on your needs:\n\n```\n$sa_tag_level_deflt  = 1.0;  # add spam info headers if at, or above that level\n$sa_tag2_level_deflt = 1.0;  # add 'spam detected' headers at that level\n$sa_kill_level_deflt = 5.0;  # triggers spam evasive actions (e.g. blocks mail)\n$sa_dsn_cutoff_level = 8;   # spam level beyond which a DSN is not sent\n# $sa_quarantine_cutoff_level = 25; # spam level beyond which quarantine is off\n$penpals_threshold_high = $sa_kill_level_deflt;  # do not waste time on hi spam\n$bounce_killer_score = 100;  # spam score points to add for joe-jobbed bounces\n```\n\nBefore you restart the amavisd service, run sa-update.\n\n"
    },
    {
      "title": "Final test",
      "level": 2,
      "content": "Note: **This article or section needs expansion.** This article or section needs expansion.\n\nThis article or section needs expansion.\n\nTo check that everything is working as intended:\n\n- Send a normal email.\n- Send an email with an EICAR test file as attachment.\n- Send an email that would result as spam.\n- Check both Postfix and Amavis logs.\n\n"
    },
    {
      "title": "See also",
      "level": 2,
      "content": "- Amavis official documentation\n- Gentoo:Complete Virtual Mail Server/amavisd spamassassin clamav\n\n"
    }
  ]
}