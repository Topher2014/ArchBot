{
  "title": "Preboot Execution Environment (Русский)",
  "url": "https://wiki.archlinux.org/title/Preboot_Execution_Environment_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Ссылки по теме\n\n- Бездисковая система\n\nВаш ноутбук поставляется без дисковода, и не позволяет загружаться с USB-накопителя? Не бойтесь, вы можете загрузиться с помощью PXE.\n\nИз Википедии:Preboot Execution Environment:\n\nВ этом руководстве PXE используется для загрузки установочного носителя с соответствующей опцией-rom, которая поддерживает PXE в целевом объекте. Это хорошо работает, когда у вас уже установлен сервер.\n\n"
    },
    {
      "title": "Как это работает",
      "level": 2,
      "content": "Грубое описание процесса загрузки с помощью PXE:\n\n- клиент (тот компьютер на который вы хотите установить) подключается к сети и опрашивает DHCP-сервера для аренды IP.\n- DHCP-сервер передает клиенту IP и другую, необходимую для сетевой загрузки, информацию.\n- затем клиент, на основе полученной информации, подключается к TFTP-серверу по протоколу TFTP (который очень похож на обычный FTP) и загружает файлы.\n\nпосле этого клиент загружает систему со скаченных файлов. После загрузки системы можно отключить сетевое соединение (образ полностью загружается в память).\n\n"
    },
    {
      "title": "Подготовка",
      "level": 2,
      "content": "Загрузите последний официальный установочный образ со страницы загрузки.\n\nЗатем смонтируйте образ:\n\n```\n# mkdir -p /mnt/archiso\n# mount -o loop,ro archlinux-2017.12.01-x86_64.iso /mnt/archiso\n```\n\n"
    },
    {
      "title": "Настройка сервера",
      "level": 2,
      "content": "Вам необходимо установить DHCP, TFTP и HTTP-сервер для настройки сети, загрузки pxelinux/kernel/initramfs, и, наконец, загрузки корневой файловой системы (соответственно).\n\nНа данный момент Arch поддерживает загрузку PXE только в стиле BIOS. Для получения дополнительной информации смотрите FS#50188.\n\n"
    },
    {
      "title": "Сеть",
      "level": 3,
      "content": "Подключите проводную сетевую карту и назначьте ее соответствующим образом.\n\n```\n# ip link set eth0 up\n# ip addr add 192.168.0.1/24 dev eth0\n```\n\n"
    },
    {
      "title": "DHCP + TFTP",
      "level": 3,
      "content": "Для настройки сети на устройстве вам потребуется как DHCP, так и TFTP-сервер, чтобы облегчить передачу файлов между сервером PXE и клиентом; dnsmasq делает и то, и другое, и очень прост в настройке.\n\nУстановите пакет dnsmasq.\n\nНастройте dnsmasq:\n\n```\n# /etc/dnsmasq.conf\n```\n\n```\nport=0\ninterface=eth0\nbind-interfaces\ndhcp-range=192.168.0.50,192.168.0.150,12h\ndhcp-boot=/arch/boot/syslinux/lpxelinux.0\ndhcp-option-force=209,boot/syslinux/archiso.cfg\ndhcp-option-force=210,/arch/\ndhcp-option-force=66,192.168.0.1\nenable-tftp\ntftp-root=/mnt/archiso\n```\n\nЗапустите dnsmasq.service.\n\n"
    },
    {
      "title": "HTTP",
      "level": 3,
      "content": "Благодаря недавним изменениям в archiso, теперь можно загрузиться с HTTP (archiso_pxe_http initcpio hook) или NFS (archiso_pxe_nfs initcpio hook); среди всех альтернатив, darkhttpd на сегодняшний день является самым тривиальным (и самым легким) для настройки.\n\nСначала, установите пакет darkhttpd.\n\nЗатем запустите darkhttpd, используя наш /mnt/archiso в качестве корневого документа:\n\n```\n# darkhttpd /mnt/archiso\n```\n\n```\ndarkhttpd/1.8, copyright (c) 2003-2011 Emil Mikulic.\nlistening on: http://0.0.0.0:80/\n```\n\nОбратите внимание, что важно, чтобы сервер работал на 80 порту. Если вы запустите darkhttpd без доступа суперпользователя, по умолчанию он будет 8080. Клиент попытается получить доступ к 80 порту, и загрузка завершится неудачно.\n\n"
    },
    {
      "title": "Установка",
      "level": 2,
      "content": "Для этой части вам нужно выяснить, как сообщить клиенту выбрать загрузку PXE; в углу экрана вместе с обычными сообщениями обычно появляется подсказка о том, какую клавишу нажать, чтобы сначала запустить загрузку PXE. На IBM x3650 при нажатии F12 появляется меню загрузки, первым вариантом которого является Network; на Dell PE 1950/2950 нажатие F12 инициирует загрузку PXE напрямую.\n\n"
    },
    {
      "title": "Загрузка",
      "level": 3,
      "content": "Просмотр journald на сервере PXE даст дополнительную информацию о том, что именно происходит на ранних этапах процесса загрузки PXE:\n\n```\n# journalctl -u dnsmasq.service -f\n```\n\n```\ndnsmasq-dhcp[2544]: DHCPDISCOVER(eth1) 00:1a:64:6a:a2:4d \ndnsmasq-dhcp[2544]: DHCPOFFER(eth1) 192.168.0.110 00:1a:64:6a:a2:4d \ndnsmasq-dhcp[2544]: DHCPREQUEST(eth1) 192.168.0.110 00:1a:64:6a:a2:4d \ndnsmasq-dhcp[2544]: DHCPACK(eth1) 192.168.0.110 00:1a:64:6a:a2:4d \ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/pxelinux.0 to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/whichsys.c32 to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso_pxe_choose.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/ifcpu64.c32 to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso_pxe_both_inc.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso_head.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso_pxe32.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso_pxe64.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/archiso_tail.cfg to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/vesamenu.c32 to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/syslinux/splash.png to 192.168.0.110\n```\n\nПосле загрузки pxelinux.0 и archiso.cfg через TFTP вам (надеюсь) будет представлено меню загрузки syslinux с несколькими параметрами, в которых вы можете выбрать Boot Arch Linux (x86_64) (HTTP).\n\nЗатем ядро и initramfs (подходящие для выбранной вами архитектуры) будут переданы снова через TFTP:\n\n```\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/x86_64/vmlinuz to 192.168.0.110\ndnsmasq-tftp[2544]: sent /mnt/archiso/arch/boot/x86_64/archiso.img to 192.168.0.110\n```\n\nЕсли все пойдет хорошо, вы должны увидеть активность на darkhttpd исходящую от PXE-target; на этом этапе ядро будет загружено на PXE-target и инициализировано:\n\n```\n1348347586 192.168.0.110 \"GET /arch/aitab\" 200 678 \"\" \"curl/7.27.0\"\n1348347587 192.168.0.110 \"GET /arch/x86_64/root-image.fs.sfs\" 200 107860206 \"\" \"curl/7.27.0\"\n1348347588 192.168.0.110 \"GET /arch/x86_64/usr-lib-modules.fs.sfs\" 200 36819181 \"\" \"curl/7.27.0\"\n1348347588 192.168.0.110 \"GET /arch/any/usr-share.fs.sfs\" 200 63693037 \"\" \"curl/7.27.0\"\n```\n\nПосле того, как корневая файловая система загружается через HTTP, вы в конечном итоге окажетесь в обычном запросе суперпользователя zsh.\n\n"
    },
    {
      "title": "После загрузки",
      "level": 3,
      "content": "Если вы не хотите, чтобы весь трафик маршрутизировался через ваш PXE-сервер (который не будет работать в любом случае, если вы не настроите его правильно), вы захотите остановить dnsmasq.service и получить новую аренду на цели установки, в зависимости от вашего сетевого расположения.\n\nВы также можете убить darkhttpd; объект уже загрузил корневую файловую систему, поэтому он больше не нужен. Пока он активен, вы также можете размонтировать установочный образ:\n\n```\n# umount /mnt/archiso\n```\n\nНа этом этапе вы можете следовать Руководство по установке.\n\n"
    },
    {
      "title": "Альтернативные способы",
      "level": 2,
      "content": "Как видно из меню syslinux, существует несколько других альтернатив:\n\n"
    },
    {
      "title": "NFS",
      "level": 3,
      "content": "Вам нужно будет настроить сервер NFS с экспортом в корне вашего смонтированного установочного носителя, который будет /mnt/archiso, если вы следовали за разделом #Подготовка. После настройки сервера добавьте следующую строку в файл /etc/exports:\n\n```\n/etc/exports\n```\n\n```\nmnt/archiso 192.168.0.0/24(ro,no_subtree_check)\n```\n\nЕсли сервер уже запущен, повторно экспортируйте файловые системы с помощью exportfs -r -a -v.\n\nНастройки по умолчанию в установщике ожидают найти NFS в /run/archiso/bootmnt, поэтому вам нужно будет отредактировать параметры загрузки. Для этого нажмите вкладку в соответствующем выборе меню загрузки и отредактируйте параметр archiso_nfs_srv соответственно:\n\n```\narchiso_nfs_srv=${pxeserver}:/mnt/archiso\n```\n\nКроме того, вы можете использовать /run/archiso/bootmnt для всего процесса.\n\nПосле загрузки образа ядра начальной загрузки Arch скопирует корневую файловую систему через NFS на загрузочный хост. Это может занять некоторое время. Как только это завершится, у вас появится работающая система.\n\n"
    },
    {
      "title": "NBD",
      "level": 3,
      "content": "Установите пакет nbd и настройте его:\n\n```\n/etc/nbd-server/config\n```\n\n```\n[generic]\n[archiso]\n    readonly = true\n    exportname = /srv/archlinux-2017.12.01-x86_64.iso\n```\n\nЗапустите nbd.service.\n\n"
    },
    {
      "title": "Существующий сервер PXE",
      "level": 3,
      "content": "Если у вас есть PXE-сервер с настроенной системой PXELINUX (например, комбинация DHCP и TFTP), вы можете добавить в файл pxelinux.cfg следующие пункты меню, чтобы загрузить Arch предпочтительным для вас способом:\n\n```\nLABEL 2\n        MENU LABEL Arch Linux x86_64\n        LINUX /путь/до/распакованного/Arch/ISO/arch/boot/x86_64/vmlinuz\n        INITRD /путь/до/распакованного/Arch/ISO/arch/boot/intel_ucode.img,/путь/до/распакованного/Arch/ISO/arch/boot/amd_ucode.img,/путь/до/распакованного/Arch/ISO/arch/boot/x86_64/archiso.img\n        APPEND archisobasedir=arch archiso_http_srv=http://httpserver/путь/до/распакованного/Arch/ISO/ ip=::\n        SYSAPPEND 2\n        TEXT HELP\n        Arch Linux 2018.09.01 x86_64\n        ENDTEXT\n```\n\nВы можете заменить archiso_http_srv на archiso_nfs_srv для NFS или archiso_nbd_srv для NBD. Добавление инструкции ip= необходимо, чтобы дать указание ядру вызвать сетевой интерфейс, прежде чем попытаться смонтировать установочный носитель по сети. Смотрите README.bootparams, чтобы узнать доступные параметры загрузки.\n\n"
    },
    {
      "title": "Ошибка переименования интерфейса DHCP",
      "level": 3,
      "content": "FS#36749 вызывает предсказуемое переименование сетевого интерфейса по умолчанию, а затем отказ клиента dhcp из-за него. Обходным путем является добавление параметра загрузки ядра net.ifnames=0, чтобы отключить предсказуемые имена интерфейсов.\n\n"
    },
    {
      "title": "Системы с небольшим объемом памяти",
      "level": 3,
      "content": "Опция copytoram initramfs может использоваться для контроля того, должна ли корневая файловая система полностью копироваться в оперативную память в полном объеме в начале загрузки.\n\nНастоятельно рекомендуется оставить этот параметр в покое, и его следует отключать только в случае необходимости (системы с физической памятью размером менее 256 МБ). Если вы хотите это сделать, добавьте copytoram=n в строку ядра.\n\n"
    },
    {
      "title": "Смотрите также",
      "level": 2,
      "content": "- PXE\n\n"
    }
  ]
}