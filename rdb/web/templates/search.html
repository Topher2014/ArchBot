{% extends "base.html" %}

{% block title %}RDB - Search{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
   <h1 class="text-3xl font-bold text-gray-900 mb-6">
       <i class="fas fa-search text-blue-600 mr-3"></i>
       Search Documentation
   </h1>
   
   <!-- Search Form -->
   <div class="bg-white rounded-lg shadow-md p-6 mb-6">
       <div class="space-y-4">
           <div>
               <label for="searchQuery" class="block text-sm font-medium text-gray-700 mb-2">
                   Search Query
               </label>
               <input type="text" id="searchQuery" placeholder="Enter your search query..." 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
           </div>
           
           <div class="grid md:grid-cols-3 gap-4">
               <div>
                   <label for="topK" class="block text-sm font-medium text-gray-700 mb-2">
                       Number of Results
                   </label>
                   <select id="topK" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                       <option value="5">5 results</option>
                       <option value="10">10 results</option>
                       <option value="15">15 results</option>
                       <option value="20">20 results</option>
                   </select>
               </div>
               
               <div>
                   <label class="block text-sm font-medium text-gray-700 mb-2">
                       Query Refinement
                   </label>
                   <label class="flex items-center">
                       <input type="checkbox" id="refineQuery" class="mr-2">
                       <span class="text-sm">Use AI query refinement</span>
                   </label>
               </div>
               
               <div class="flex items-end">
                   <button onclick="performSearch()" 
                           class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                       <i class="fas fa-search mr-2"></i>Search
                   </button>
               </div>
           </div>
       </div>
   </div>
   
   <!-- Search Suggestions -->
   <div id="suggestions" class="bg-white rounded-lg shadow-md p-4 mb-6 hidden">
       <h3 class="text-sm font-medium text-gray-700 mb-2">Suggested Searches:</h3>
       <div id="suggestionsList" class="flex flex-wrap gap-2"></div>
   </div>
   
   <!-- Loading -->
   <div id="searchLoading" class="hidden">
       <div class="bg-white rounded-lg shadow-md p-6 text-center">
           <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
           <p class="text-gray-600">Searching...</p>
       </div>
   </div>
   
   <!-- Search Results -->
   <div id="searchResults" class="hidden">
       <div class="bg-white rounded-lg shadow-md p-6 mb-4">
           <h3 class="text-lg font-semibold text-gray-800 mb-2">Search Results</h3>
           <div id="searchInfo" class="text-sm text-gray-600 mb-4"></div>
           <div id="resultsList"></div>
       </div>
   </div>
   
   <!-- No Results -->
   <div id="noResults" class="hidden">
       <div class="bg-white rounded-lg shadow-md p-6 text-center">
           <i class="fas fa-search text-gray-400 text-3xl mb-4"></i>
           <h3 class="text-lg font-semibold text-gray-800 mb-2">No Results Found</h3>
           <p class="text-gray-600">Try adjusting your search terms or enabling query refinement.</p>
       </div>
   </div>
   
   <!-- Search History -->
   <div class="bg-white rounded-lg shadow-md p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">
           <i class="fas fa-history text-purple-600 mr-2"></i>
           Recent Searches
       </h3>
       <div id="searchHistory">
           <div class="flex justify-center">
               <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
           </div>
       </div>
   </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
   loadSearchHistory();
   loadSuggestions();
   
   // Handle URL params for direct search
   const urlParams = new URLSearchParams(window.location.search);
   const query = urlParams.get('q');
   if (query) {
       document.getElementById('searchQuery').value = query;
       performSearch();
   }
   
   // Handle Enter key
   document.getElementById('searchQuery').addEventListener('keypress', function(e) {
       if (e.key === 'Enter') {
           performSearch();
       }
   });
});

function performSearch() {
   const query = document.getElementById('searchQuery').value.trim();
   if (!query) {
       alert('Please enter a search query');
       return;
   }
   
   const topK = parseInt(document.getElementById('topK').value);
   const refineQuery = document.getElementById('refineQuery').checked;
   
   // Show loading, hide other elements
   showElement('searchLoading');
   hideElement('searchResults');
   hideElement('noResults');
   
   const searchData = {
       query: query,
       top_k: topK,
       refine_query: refineQuery
   };
   
   fetch('/api/search/query', {
       method: 'POST',
       headers: {
           'Content-Type': 'application/json'
       },
       body: JSON.stringify(searchData)
   })
   .then(response => response.json())
   .then(data => {
       hideElement('searchLoading');
       
       if (data.error) {
           alert('Search error: ' + data.error);
           return;
       }
       
       if (data.results && data.results.length > 0) {
           displayResults(data);
       } else {
           showElement('noResults');
       }
       
       // Refresh search history
       loadSearchHistory();
   })
   .catch(error => {
       hideElement('searchLoading');
       alert('Search failed: ' + error.message);
   });
}

function displayResults(data) {
   const searchInfo = document.getElementById('searchInfo');
   const resultsList = document.getElementById('resultsList');
   
   // Search info
   searchInfo.innerHTML = `
       <div class="flex flex-wrap gap-4 text-sm">
           <span><strong>Query:</strong> ${data.query}</span>
           ${data.refined_query !== data.query ? `<span><strong>Refined:</strong> ${data.refined_query}</span>` : ''}
           <span><strong>Results:</strong> ${data.total_results}</span>
           <span><strong>Time:</strong> ${data.search_time_ms}ms</span>
       </div>
   `;
   
   // Results list
   resultsList.innerHTML = data.results.map((result, index) => `
       <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition duration-200">
           <div class="flex justify-between items-start mb-2">
               <h4 class="text-lg font-semibold text-blue-600">
                   <a href="${result.url}" target="_blank" class="hover:underline">
                       ${result.page_title}
                   </a>
               </h4>
               <div class="text-right text-sm text-gray-500">
                   <div>Rank #${result.rank}</div>
                   <div>Score: ${result.score.toFixed(4)}</div>
               </div>
           </div>
           
           <div class="text-sm text-gray-600 mb-2">
               <i class="fas fa-folder mr-1"></i>
               ${result.section_path}
               <span class="ml-3">
                   <i class="fas fa-tag mr-1"></i>
                   ${result.chunk_type}
               </span>
           </div>
           
           <p class="text-gray-800 mb-3">${result.content}</p>
           
           <a href="${result.url}" target="_blank" 
              class="text-blue-600 hover:text-blue-800 text-sm font-medium">
               <i class="fas fa-external-link-alt mr-1"></i>
               View on Arch Wiki
           </a>
       </div>
   `).join('');
   
   showElement('searchResults');
}

function loadSearchHistory() {
   fetch('/api/search/history?limit=10')
       .then(response => response.json())
       .then(data => {
           const historyDiv = document.getElementById('searchHistory');
           
           if (data.history && data.history.length > 0) {
               historyDiv.innerHTML = `
                   <div class="space-y-2">
                       ${data.history.map(search => `
                           <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                               <div class="flex-1">
                                   <button onclick="useHistoryQuery('${search.original_query.replace(/'/g, "\\'")}')" 
                                           class="text-left hover:text-blue-600 transition duration-200">
                                       <div class="font-medium">${search.original_query}</div>
                                       ${search.refined_query !== search.original_query ? 
                                           `<div class="text-sm text-gray-500">→ ${search.refined_query}</div>` : ''}
                                   </button>
                               </div>
                               <div class="text-sm text-gray-500">
                                   ${search.results_count} results • ${search.search_time_ms}ms
                               </div>
                           </div>
                       `).join('')}
                   </div>
               `;
           } else {
               historyDiv.innerHTML = '<p class="text-gray-500">No search history yet</p>';
           }
       })
       .catch(error => {
           document.getElementById('searchHistory').innerHTML = 
               '<p class="text-red-600">Error loading search history</p>';
       });
}

function loadSuggestions() {
   fetch('/api/search/suggestions')
       .then(response => response.json())
       .then(data => {
           if (data.suggestions && data.suggestions.length > 0) {
               const suggestionsList = document.getElementById('suggestionsList');
               suggestionsList.innerHTML = data.suggestions.map(suggestion => `
                   <button onclick="useSuggestion('${suggestion}')" 
                           class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition duration-200">
                       ${suggestion}
                   </button>
               `).join('');
               showElement('suggestions');
           }
       })
       .catch(error => {
           console.log('Could not load suggestions:', error);
       });
}

function useHistoryQuery(query) {
   document.getElementById('searchQuery').value = query;
   performSearch();
}

function useSuggestion(suggestion) {
   document.getElementById('searchQuery').value = suggestion;
   performSearch();
}

function showElement(id) {
   document.getElementById(id).classList.remove('hidden');
}

function hideElement(id) {
   document.getElementById(id).classList.add('hidden');
}
</script>
{% endblock %}
